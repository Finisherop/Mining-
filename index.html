<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CRYPTO FARMING</title>
    <link rel="icon" href="https://i.ibb.co/GfSXrc6X/1758858256731.png" type="image/jpeg">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        /* --- Global Styles & Dark Theme --- */
        :root {
            --bg-color: #121212;
            --primary-surface: #1e1e1e;
            --secondary-surface: #2a2a2a;
            --primary-accent: #f0b90b;
            --secondary-accent: #4caf50;
            --primary-text: #ffffff;
            --secondary-text: #b0b0b0;
            --danger-color: #f44336;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .hidden { display: none !important; }
        /* --- Loader --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            font-size: 1.5em;
        }
        /* --- Main App Container --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--primary-surface);
            border-bottom: 1px solid var(--secondary-surface);
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .coin-balance {
            font-size: 1.2em;
            font-weight: bold;
        }
        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            position: relative;
        }
        .tab-content {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- Farming Tab --- */
        #farming-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            gap: 20px;
        }
        #logo-container {
            position: relative;
        }
        .farm-logo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid var(--primary-accent);
            box-shadow: 0 0 20px var(--primary-accent);
        }
        .progress-bar-container {
            width: 80%;
            background-color: var(--secondary-surface);
            border-radius: 10px;
            padding: 3px;
        }
        .progress-bar {
            width: 0%;
            height: 10px;
            background-color: var(--secondary-accent);
            border-radius: 8px;
            transition: width 1s linear;
        }
        #farm-timer {
            font-size: 1.1em;
            color: var(--secondary-text);
        }
        #farm-button {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-accent);
            color: var(--bg-color);
            cursor: pointer;
            transition: transform 0.2s;
        }
        #farm-button:disabled {
            background-color: var(--secondary-surface);
            color: var(--secondary-text);
            cursor: not-allowed;
        }
        #farm-button:active {
            transform: scale(0.95);
        }
        /* --- Falling Leaves Animation --- */
        #falling-leaves-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
        }
        .leaf {
            position: absolute;
            top: -10%;
            font-size: 1.5em; /* Emoji size */
            animation: fall linear infinite;
        }
        @keyframes fall {
            to {
                transform: translateY(105vh) rotate(360deg);
            }
        }
        /* --- Level Up Popup --- */
        #level-up-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background: var(--primary-surface);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            border: 2px solid var(--primary-accent);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }
        #level-up-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }
        #confetti-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none;
        }
        /* --- General Task/List Styles --- */
        .task-list, .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .task-item, .history-item {
            background: var(--primary-surface);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-info, .history-info { flex-grow: 1; }
        .task-item button, .form-container button {
            padding: 8px 15px;
            background: var(--primary-accent);
            color: var(--bg-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .form-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-container input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--secondary-surface);
            background-color: var(--bg-color);
            color: var(--primary-text);
            font-size: 1em;
        }
        /* --- Navigation Bar --- */
        .nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--primary-surface);
            padding: 10px 0;
            border-top: 1px solid var(--secondary-surface);
        }
        .nav-item {
            cursor: pointer;
            padding: 5px 15px;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            text-align: center;
        }
        .nav-item.active {
            opacity: 1;
            transform: scale(1.1);
            color: var(--primary-accent);
        }
        /* --- Admin Panel --- */
        #admin-panel {
            padding: 20px;
            background: #f0f2f5;
            color: #333;
            height: 100vh;
            overflow-y: auto;
        }
        #admin-login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-box input {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .login-box button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .admin-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .admin-section h3 { margin-top: 0; }
        .withdrawal-table {
            width: 100%;
            border-collapse: collapse;
        }
        .withdrawal-table th, .withdrawal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="loader">Loading... üí∞</div>
    <div id="app-container" class="hidden">
        <header class="header">
            <div id="coin-balance-container" class="coin-balance">
                üí∞ 0
            </div>
            <div class="profile-info">
                <span id="user-name">User</span>
                <img id="user-pic" class="profile-pic" src="https://t.me/i/userpic/320/1.jpg" alt="P">
            </div>
        </header>
        <main class="main-content">
            <div id="farming-tab" class="tab-content">
                 <div id="falling-leaves-container"></div>
                <h2>CRYPTO FARMING</h2>
                <div id="logo-container">
                    <img src="https://i.ibb.co/GfSXrc6X/1758858256731.png" alt="Crypto Farm Logo" class="farm-logo">
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="farm-progress"></div>
                </div>
                <span id="farm-timer">Ready to farm!</span>
                <button id="farm-button">Start Farming</button>
            </div>
            <div id="tasks-tab" class="tab-content hidden">
                <h2>Complete Tasks for Rewards</h2>
                <div class="task-list">
                    <div class="task-item">
                        <div class="task-info">
                            <h4>üé¨ YouTube Video Task</h4>
                            <p>Enter the secret key from the video to claim.</p>
                        </div>
                        <button onclick="openYouTube()">Open</button>
                    </div>
                    <div class="task-item">
                         <div class="task-info">
                            <h4>‚úàÔ∏è Join Telegram Channel</h4>
                            <p>Join our channel for updates and rewards.</p>
                        </div>
                        <button onclick="openChannel()">Open</button>
                    </div>
                     <div class="task-item">
                         <div class="task-info">
                            <h4>üë• Join Telegram Group</h4>
                            <p>Join our group to be part of the community.</p>
                        </div>
                        <button onclick="openGroup()">Open</button>
                    </div>
                    <div class="task-item">
                        <div class="task-info">
                            <h4>üì∫ Watch Ad</h4>
                            <p>Watch a short ad to earn coins.</p>
                        </div>
                        <button onclick="watchAd()">Watch</button>
                    </div>
                </div>
            </div>
            <div id="referral-tab" class="tab-content hidden">
                 <h2>Refer & Earn</h2>
                <div class="form-container">
                    <p>Share your link to earn coins for every friend who joins!</p>
                    <input type="text" id="referral-link" readonly>
                    <button onclick="copyReferralLink()">Copy Link</button>
                </div>
                 <h3>Your Referrals</h3>
                <div id="referral-history-list" class="history-list">
                    <p>No referrals yet.</p>
                </div>
            </div>
            <div id="exchange-tab" class="tab-content hidden">
                <h2>Exchange & Withdraw</h2>
                <div class="form-container">
                    <h4>Convert Coins</h4>
                    <p id="conversion-rate">Conversion Rate: 1000 üí∞ = 1 INR</p>
                    <input type="number" id="convert-amount" placeholder="Enter coin amount">
                    <button onclick="convertCoins()">Convert</button>
                    <h4 style="margin-top: 20px;">Request Withdrawal</h4>
                    <select id="withdrawal-method">
                        <option value="upi">UPI</option>
                        <option value="usdt">USDT (TRC20)</option>
                    </select>
                    <input type="text" id="withdrawal-address" placeholder="Enter UPI ID or USDT Address">
                    <input type="number" id="withdrawal-amount" placeholder="Enter INR/USDT amount">
                    <button onclick="requestWithdrawal()">Request</button>
                </div>
                <h3>Withdrawal History</h3>
                 <div id="withdrawal-history-list" class="history-list">
                     <p>No withdrawal history.</p>
                 </div>
            </div>
            <div id="profile-tab" class="tab-content hidden">
                <h2>My Profile</h2>
                <div class="task-list">
                    <div class="task-item"><span>User ID</span> <strong id="profile-userid">...</strong></div>
                    <div class="task-item"><span>Total Coins</span> <strong id="profile-coins">...</strong></div>
                    <div class="task-item"><span>Total Exchanged</span> <strong id="profile-exchanged">...</strong></div>
                    <div class="task-item"><span>Referrals</span> <strong id="profile-referrals">...</strong></div>
                    <div class="task-item"><span>Current Level</span> <strong id="profile-level">...</strong></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <div class="nav-item active" data-tab="farming-tab">üè†<br>Farm</div>
            <div class="nav-item" data-tab="tasks-tab">üìã<br>Tasks</div>
            <div class="nav-item" data-tab="referral-tab">üë•<br>Refer</div>
            <div class="nav-item" data-tab="exchange-tab">üí∏<br>Exchange</div>
            <div class="nav-item" data-tab="profile-tab">üë§<br>Profile</div>
        </nav>
        <div id="level-up-popup">
            <div id="confetti-container"></div>
            <h2>LEVEL UP!</h2>
            <p>You've reached <strong id="new-level">Level X</strong>!</p>
            <p>üéâ Rewards Unlocked! üéâ</p>
        </div>
    </div>
    <div id="admin-panel" class="hidden">
        <div id="admin-login-screen">
            <div class="login-box">
                <h2>CRYPTO FARMING - Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Email" value="admin@gmail.com">
                <input type="password" id="admin-password" placeholder="Password" value="admin123">
                <button onclick="handleAdminLogin()">Login</button>
                <p id="admin-login-error" style="color:red;"></p>
            </div>
        </div>
        <div id="admin-dashboard" class="hidden">
            <h2>Admin Dashboard</h2>
            <div class="admin-section">
                <h3>Global Settings</h3>
                <label>Farming Rate (coins/min):</label>
                <input type="number" id="setting-farm-rate">
                <br><br>
                <label>YouTube Task Key:</label>
                <input type="text" id="setting-yt-key">
                 <br><br>
                <label>Conversion Rate (Coins per 1 INR/USDT):</label>
                <input type="number" id="setting-conversion-rate">
                <br><br>
                <button onclick="saveAdminSettings()">Save Settings</button>
            </div>
            <div class="admin-section">
                <h3>Withdrawal Requests</h3>
                <table id="withdrawal-requests-table" class="withdrawal-table">
                    <thead><tr><th>User ID</th><th>Amount</th><th>Method</th><th>Address</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
             <div class="admin-section">
                <h3>Broadcast Message</h3>
                <textarea id="broadcast-message" rows="4" style="width: 100%;"></textarea>
                <button onclick="sendBroadcast()">Send to All Users</button>
            </div>
        </div>
    </div>
    <script>                  
    // --- JAVASCRIPT LOGIC --- //
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration --- //
        const firebaseConfig = {
            apiKey: "AIzaSyBWhjcgCmp5A6V5uCSSB-j8yMKqRYZuHIY",
            authDomain: "mining-bot-6131b.firebaseapp.com",
            projectId: "mining-bot-6131b",
            storageBucket: "mining-bot-6131b.firebasestorage.app",
            messagingSenderId: "614776449697",
            appId: "1:614776449697:web:a13c41c86b4aa16b2adee0"
        };

        // --- Firebase Initialization --- //
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization failed. Make sure you have pasted your config object.", e);
            document.getElementById('loader').innerText = "Firebase Config Missing!";
            return;
        }
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        // --- Global Variables --- //
        let currentUser = null;
        let userData = null;
        let farmInterval = null;

        // Firestore Security Rules (for reference, apply these in your Firebase Console)
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /users/{userId} {
              allow read, write: if request.auth.uid == userId;
            }
            match /withdrawals/{withdrawalId} {
                allow create: if request.auth != null;
                allow read: if request.auth.uid == resource.data.userId;
            }
            match /settings/global {
                allow read: if true;
            }
          }
        }
        */

        /**
         * Main initialization function. Determines if the user is in Telegram or a browser.
         */
        function initializeApp() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe.user;
                document.getElementById('app-container').classList.remove('hidden');
                initUserPanel();
            } else {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-login-screen').classList.remove('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        }

        // --- USER PANEL LOGIC --- //
        async function initUserPanel() {
            document.getElementById('user-name').innerText = currentUser.first_name;
            if (currentUser.photo_url) {
                document.getElementById('user-pic').src = currentUser.photo_url;
            }
            await loadUserData();
            setupEventListeners();
        }

        async function loadUserData() {
            const userId = currentUser.id.toString();
            const cachedData = localStorage.getItem(`userData_${userId}`);
            if (cachedData) {
                userData = JSON.parse(cachedData);
                console.log("Loaded user data from cache.");
                updateUI();
            }

            const userRef = db.collection('users').doc(userId);
            const doc = await userRef.get();
            if (doc.exists) {
                userData = doc.data();
                if (!cachedData || JSON.stringify(userData) !== cachedData) {
                    console.log("Fetched fresh user data from Firebase.");
                    updateUI();
                }
            } else {
                console.log("Creating new user in Firebase.");
                userData = {
                    id: userId,
                    username: currentUser.username || 'N/A',
                    firstName: currentUser.first_name,
                    coins: 0,
                    xp: 0,
                    level: 1,
                    farmingStartTime: null,
                    farmingDuration: 24 * 60 * 60 * 1000,
                    referrals: [],
                    exchangedTotal: 0
                };
                await userRef.set(userData);
                updateUI();
            }
            localStorage.setItem(`userData_${userId}`, JSON.stringify(userData));
        }

        function updateUI() {
            if (!userData) return;
            document.getElementById('coin-balance-container').innerText = `üí∞ ${Math.floor(userData.coins)}`;
            checkFarmingStatus();
        }

        async function syncUserData(updatedData) {
            Object.assign(userData, updatedData);
            localStorage.setItem(`userData_${currentUser.id}`, JSON.stringify(userData));
            const userRef = db.collection('users').doc(currentUser.id.toString());
            await userRef.update(updatedData);
            console.log("Synced data:", updatedData);
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const tabId = e.currentTarget.dataset.tab;
                    switchTab(tabId);
                });
            });
            document.getElementById('farm-button').addEventListener('click', handleFarmButtonClick);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'referral-tab') loadReferralData();
            if (tabId === 'exchange-tab') loadWithdrawalHistory();
            if (tabId === 'profile-tab') updateProfileTab();
        }

        // --- FARMING LOGIC --- //
        function handleFarmButtonClick() {
            const button = document.getElementById('farm-button');
            if (button.innerText.includes('Start')) {
                startFarming();
            } else if (button.innerText.includes('Claim')) {
                claimReward();
            }
        }

        async function startFarming() {
            await syncUserData({ farmingStartTime: Date.now() });
            checkFarmingStatus();
        }

        async function claimReward() {
            const farmRate = 100; // coins per minute
            const elapsedMinutes = userData.farmingDuration / (60 * 1000);
            const coinsEarned = farmRate * elapsedMinutes;
            const newCoins = userData.coins + coinsEarned;
            await syncUserData({ coins: newCoins, farmingStartTime: null, xp: userData.xp + 100 });
            alert(`You claimed ${coinsEarned.toFixed(0)} coins!`);
            checkLevelUp(userData.xp, userData.xp + 100);
            updateUI();
        }

        function checkFarmingStatus() {
            const button = document.getElementById('farm-button');
            const timerEl = document.getElementById('farm-timer');
            const progressEl = document.getElementById('farm-progress');
            if (farmInterval) clearInterval(farmInterval);

            if (userData.farmingStartTime) {
                const endTime = userData.farmingStartTime + userData.farmingDuration;
                farmInterval = setInterval(() => {
                    const now = Date.now();
                    const timeLeft = endTime - now;
                    if (timeLeft <= 0) {
                        clearInterval(farmInterval);
                        button.innerText = 'Claim Reward';
                        button.disabled = false;
                        timerEl.innerText = 'Farming complete!';
                        progressEl.style.width = '100%';
                        stopLeafAnimation();
                        return;
                    }
                    button.innerText = 'Farming...';
                    button.disabled = true;
                    startLeafAnimation();
                    const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                    const seconds = Math.floor((timeLeft / 1000) % 60);
                    timerEl.innerText = `Time left: ${hours}h ${minutes}m ${seconds}s`;
                    const progress = 100 - (timeLeft / userData.farmingDuration) * 100;
                    progressEl.style.width = `${progress}%`;
                }, 1000);
            } else {
                button.innerText = 'Start Farming';
                button.disabled = false;
                timerEl.innerText = 'Ready to farm!';
                progressEl.style.width = '0%';
                stopLeafAnimation();
            }
        }

        // --- ANIMATION LOGIC --- //
        let leafAnimationActive = false;
        function startLeafAnimation() {
            if (leafAnimationActive) return;
            leafAnimationActive = true;
            const container = document.getElementById('falling-leaves-container');
            for (let i = 0; i < 15; i++) {
                const leaf = document.createElement('div');
                leaf.className = 'leaf';
                leaf.innerHTML = ['üçÇ', 'üçÅ'][Math.round(Math.random())];
                leaf.style.left = `${Math.random() * 100}vw`;
                leaf.style.animationDuration = `${Math.random() * 3 + 4}s`;
                leaf.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(leaf);
            }
        }
        function stopLeafAnimation() {
            leafAnimationActive = false;
            document.getElementById('falling-leaves-container').innerHTML = '';
        }

        // --- LEVEL UP & CONFETTI --- //
        function checkLevelUp(oldXp, newXp) {
            const levelThreshold = (level) => Math.floor(100 * Math.pow(level, 1.5));
            const currentLevelThreshold = levelThreshold(userData.level);
            if (newXp >= currentLevelThreshold) {
                const newLevel = userData.level + 1;
                syncUserData({ level: newLevel });
                showLevelUpPopup(newLevel);
            }
        }
        function showLevelUpPopup(level) {
            const popup = document.getElementById('level-up-popup');
            document.getElementById('new-level').innerText = `Level ${level}`;
            popup.classList.add('show');
            createConfetti();
            setTimeout(() => {
                popup.classList.remove('show');
            }, 4000);
        }
        function createConfetti() {
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = `${-20}%`;
                confetti.style.animation = `confetti-fall ${Math.random() * 2 + 3}s linear ${Math.random() * 2}s forwards`;
                container.appendChild(confetti);
            }
        }
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `@keyframes confetti-fall { to { transform: translateY(150vh) rotate(${Math.random() * 720}deg); opacity: 0; } }`;
        document.head.appendChild(styleSheet);
        
        // --- TABS LOGIC & UTILITIES --- //

        async function loadWithdrawalHistory() {
            const querySnapshot = await db.collection('withdrawals').where('userId', '==', currentUser.id.toString()).get();
            const listEl = document.getElementById('withdrawal-history-list');
            listEl.innerHTML = '';
            if (querySnapshot.empty) {
                listEl.innerHTML = '<p>No withdrawal history.</p>';
                return;
            }
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                   <div class="history-info">
                       <strong>${data.amount} ${data.method.toUpperCase()}</strong> to ${data.address}
                       <br>
                       <small>Status: ${data.status}</small>
                   </div>
                `;
                listEl.appendChild(item);
            });
        }
        
        function updateProfileTab() {
            document.getElementById('profile-userid').innerText = userData.id;
            document.getElementById('profile-coins').innerText = Math.floor(userData.coins);
            document.getElementById('profile-exchanged').innerText = userData.exchangedTotal || 0;
            document.getElementById('profile-referrals').innerText = userData.referrals.length;
            document.getElementById('profile-level').innerText = userData.level;
        }

        // --- ADMIN PANEL LOGIC --- //
        window.handleAdminLogin = function() {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            if (email === 'admin@gmail.com' && pass === 'admin123') {
                document.getElementById('admin-login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                loadAdminData();
            } else {
                errorEl.innerText = "Invalid credentials.";
            }
        }
        async function loadAdminData() {
            const settings = (await db.collection('settings').doc('global').get()).data();
            if (settings) {
                document.getElementById('setting-farm-rate').value = settings.farmRate || 100;
                document.getElementById('setting-yt-key').value = settings.ytKey || '';
                document.getElementById('setting-conversion-rate').value = settings.conversionRate || 1000;
            }
            const querySnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            const tableBody = document.querySelector('#withdrawal-requests-table tbody');
            tableBody.innerHTML = '';
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = tableBody.insertRow();
                row.innerHTML = `
                   <td>${data.userId}</td>
                   <td>${data.amount}</td>
                   <td>${data.method}</td>
                   <td>${data.address}</td>
                   <td>${data.status}</td>
                   <td>
                       <button onclick="updateWithdrawalStatus('${doc.id}', 'approved')">Approve</button>
                       <button onclick="updateWithdrawalStatus('${doc.id}', 'rejected')" style="background:var(--danger-color)">Reject</button>
                   </td>
                `;
            });
        }
        window.saveAdminSettings = async function() {
            const settings = {
                farmRate: parseInt(document.getElementById('setting-farm-rate').value),
                ytKey: document.getElementById('setting-yt-key').value,
                conversionRate: parseInt(document.getElementById('setting-conversion-rate').value)
            };
            await db.collection('settings').doc('global').set(settings, { merge: true });
            alert("Settings saved!");
        }
        window.updateWithdrawalStatus = async function(docId, status) {
            const reason = prompt(`Enter reason for ${status} (optional):`);
            await db.collection('withdrawals').doc(docId).update({ status: status, adminNote: reason || '' });
            alert(`Withdrawal ${status}. User will be notified.`);
            loadAdminData();
        }

        // --- TASK OPENERS & UTILITIES --- //
        window.openYouTube = function() {
            const url = "https://www.youtube.com/watch?v=YOUR_VIDEO_ID";
            tg.openLink(url);
        };
        window.openChannel = function() {
            const url = "https://t.me/your_channel_name";
            tg.openLink(url);
        };
        window.openGroup = function() {
            const url = "https://t.me/your_group_name";
            tg.openLink(url);
        };
        
        window.watchAd = function() {
            // Placeholder for your ad logic
            tg.showAlert("Watch Ad function called.");
        };

        window.convertCoins = async function() {
            const amount = parseInt(document.getElementById('convert-amount').value);
            if (isNaN(amount) || amount <= 0) {
                tg.showAlert("Enter a valid coin amount to convert.");
                return;
            }
            if (amount > (userData.coins || 0)) {
                tg.showAlert("You do not have enough coins.");
                return;
            }
            const settingsDoc = await db.collection('settings').doc('global').get();
            const settings = settingsDoc.exists ? settingsDoc.data() : {};
            const rate = settings?.conversionRate || 1000;
            const converted = amount / rate;
            await syncUserData({
                coins: (userData.coins || 0) - amount,
                exchangedTotal: (userData.exchangedTotal || 0) + converted
            });
            tg.showAlert(`Converted ${amount} coins into ${converted.toFixed(4)} units (rate ${rate}).`);
            updateUI();
        };

        // FIX: Corrected and merged requestWithdrawal function
        window.requestWithdrawal = async function() {
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('withdrawal-method').value;
            const address = document.getElementById('withdrawal-address').value.trim();

            if (isNaN(amount) || amount <= 0 || !address) {
                tg.showAlert("Please fill all withdrawal fields correctly.");
                return;
            }
            
            const userExchanged = (userData.exchangedTotal || 0);
            if (amount > userExchanged) {
                tg.showAlert("Insufficient exchanged balance to withdraw.");
                return;
            }

            await db.collection('withdrawals').add({
                userId: currentUser.id.toString(),
                amount,
                method,
                address,
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            await syncUserData({ exchangedTotal: userExchanged - amount });
            tg.showAlert("Withdrawal request submitted!");
            loadWithdrawalHistory();
        };

        // FIX: Corrected and single version of loadReferralData
        function loadReferralData() {
            const linkInput = document.getElementById('referral-link');
            const botUrl = `https://t.me/Finisher_farming_bot?start=${currentUser.id}`; // Updated bot name
            linkInput.value = botUrl;
            
            // This part can be improved to show actual referral history
            const displayEl = document.getElementById('referral-history-list');
            if (displayEl) {
                // You would fetch and display real referrals here
                 displayEl.innerHTML = '<p>Your referral list will appear here.</p>';
            }
        }
        
        // FIX: Corrected and single version of copyReferralLink
        window.copyReferralLink = async function() {
            const linkInput = document.getElementById('referral-link');
            if (!linkInput) return;
            try {
                // Modern async clipboard API
                await navigator.clipboard.writeText(linkInput.value);
                tg.showAlert('Referral link copied!');
            } catch (err) {
                // Fallback for older browsers
                linkInput.select();
                document.execCommand('copy');
                tg.showAlert('Referral link copied!');
            }
        };

        // --- START THE APP --- //
        initializeApp();
    });
</script>

    <!-- Ad SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9934705' data-sdk='show_9934705'></script>
</body>
</html>
