<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚀</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#0b0f1a" />
    <meta name="description" content="Premium Bot Dashboard - Farm coins, complete tasks, and earn rewards!" />
    <title>Premium Bot Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- FIX: Firebase CDN for immediate availability -->
    <script type="module">
      // Import Firebase modules from CDN for immediate availability
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue, off, push, update } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js';
      
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD-EiTLr-bDDDKgR5tvzguyNfdlKDO8Rw8",
        authDomain: "tap-and-earn-d3583.firebaseapp.com",
        databaseURL: "https://tap-and-earn-d3583-default-rtdb.firebaseio.com",
        projectId: "tap-and-earn-d3583",
        storageBucket: "tap-and-earn-d3583.firebasestorage.app",
        messagingSenderId: "759083332180",
        appId: "1:759083332180:web:165eb0bf070956fb0033c1"
      };

      // Initialize Firebase immediately
      try {
        console.log('🔥 Initializing Firebase from CDN...');
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase globally available
        window.firebaseApp = app;
        window.database = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebasePush = push;
        window.firebaseUpdate = update;
        
        // Test connection with enhanced logging
        const connectedRef = ref(database, '.info/connected');
        onValue(connectedRef, (snapshot) => {
          if (snapshot.val() === true) {
            console.log('✅ Firebase connected successfully.');
            window.firebaseConnected = true;
            
            // Dispatch ready event
            window.dispatchEvent(new CustomEvent('firebaseReady'));
          } else {
            console.log('❌ Firebase disconnected - retrying connection...');
            window.firebaseConnected = false;
          }
        });
        
        console.log('🎯 Firebase initialization complete');
      } catch (error) {
        console.error('❌ Firebase initialization failed:', error);
        window.firebaseError = error;
      }
    </script>
  </head>
  <body>
    <div id="root">
      <!-- FIX: Loading screen while app initializes -->
      <div id="loading-screen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #0b0f1a 0%, #1a1d3a 100%); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <div style="text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">🚀</div>
          <h2 style="margin: 0 0 10px 0; font-weight: 600;">Mining PRO</h2>
          <p style="margin: 0; color: #a0a0a0;">Loading your dashboard...</p>
          <div style="margin-top: 20px;">
            <div style="width: 200px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin: 0 auto;">
              <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #00d4ff, #0099cc); animation: loading 2s infinite;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- FIX: Vite will inject the correct script tags during build -->
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- FIX: Enhanced error handling and initialization -->
    <script>
      // Loading animation styles
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse {
          0%, 100% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.1); opacity: 0.8; }
        }
        @keyframes loading {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }
      `;
      document.head.appendChild(style);
      
      // Hide loading screen when React app mounts
      function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
          loadingScreen.style.transition = 'opacity 0.5s ease-out';
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            loadingScreen.remove();
          }, 500);
        }
      }
      
      // Enhanced loading timeout with retry-safe behavior
      let loadingTimeout = setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen && loadingScreen.parentNode) {
          console.log('App initialization taking longer than expected, showing retry options');
          loadingScreen.innerHTML = `
            <div style="text-align: center;">
              <div style="font-size: 64px; margin-bottom: 20px; animation: pulse 2s infinite;">🔄</div>
              <h2 style="margin: 0 0 15px 0; font-weight: 600;">Slow Network Detected</h2>
              <p style="margin: 0 0 20px 0; color: #a0a0a0; line-height: 1.5;">
                The app is taking longer than usual to load.<br>
                This might be due to a slow network connection.
              </p>
              <div style="background: #1a1d3a; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                <div style="margin-bottom: 8px;">
                  <strong>Checking:</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                  <span>📱 Telegram WebApp</span>
                  <span id="telegram-status">⏳</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>🔥 Firebase Connection</span>
                  <span id="firebase-status">⏳</span>
                </div>
              </div>
              <button onclick="window.location.reload()" style="background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-right: 10px; box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);">
                🔄 Retry Loading
              </button>
              <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload();" style="background: #333; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px;">
                🗑️ Clear Cache & Reload
              </button>
            </div>
          `;
          
          // Update status indicators
          const updateStatus = () => {
            const telegramStatus = document.getElementById('telegram-status');
            const firebaseStatus = document.getElementById('firebase-status');
            
            if (telegramStatus) {
              telegramStatus.textContent = window.Telegram?.WebApp ? '✓' : '⚠️';
              telegramStatus.style.color = window.Telegram?.WebApp ? '#10b981' : '#f59e0b';
            }
            
            if (firebaseStatus) {
              firebaseStatus.textContent = window.firebaseConnected ? '✓' : '⚠️';
              firebaseStatus.style.color = window.firebaseConnected ? '#10b981' : '#f59e0b';
            }
          };
          
          updateStatus();
          setInterval(updateStatus, 1000);
        }
      }, 15000); // Increased to 15 seconds to give more time
      
      // Clear timeout if app loads successfully
      window.clearLoadingTimeout = () => {
        if (loadingTimeout) {
          clearTimeout(loadingTimeout);
          loadingTimeout = null;
        }
      };
      
      // Global error handler
      window.addEventListener('error', function(e) {
        console.error('Application Error:', e.error);
        console.error('Error details:', {
          message: e.message,
          filename: e.filename,
          lineno: e.lineno,
          colno: e.colno,
          stack: e.error?.stack
        });
        
        // Show user-friendly error message if main app fails to load
        if (e.filename && (e.filename.includes('index-') || e.message.includes('Loading chunk'))) {
          const root = document.getElementById('root');
          if (root) {
            root.innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #0b0f1a 0%, #1a1d3a 100%); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px;">
                <div style="max-width: 400px;">
                  <div style="font-size: 64px; margin-bottom: 20px;">⚠️</div>
                  <h2 style="margin: 0 0 15px 0; font-weight: 600;">Loading Error</h2>
                  <p style="margin: 0 0 20px 0; color: #a0a0a0; line-height: 1.5;">
                    Unable to load the application. This might be due to a network issue or outdated cache.
                  </p>
                  <div style="background: #1a1d3a; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                    <strong>Error:</strong> ${e.message}<br>
                    <strong>File:</strong> ${e.filename || 'Unknown'}<br>
                    <strong>Line:</strong> ${e.lineno || 'Unknown'}
                  </div>
                  <button onclick="window.location.reload()" style="background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-right: 10px; box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);">
                    🔄 Reload Page
                  </button>
                  <button onclick="localStorage.clear(); sessionStorage.clear(); window.location.reload();" style="background: #333; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px;">
                    🗑️ Clear Cache & Reload
                  </button>
                </div>
              </div>
            `;
          }
        }
      });
      
      // Handle Promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled Promise Rejection:', e.reason);
        
        // If Firebase connection fails, show specific message
        if (e.reason && e.reason.toString().includes('Firebase')) {
          console.warn('Firebase connection issue detected:', e.reason);
        }
      });
      
      // Enhanced Telegram WebApp initialization with detailed logging
      function initializeTelegram() {
        try {
          if (window.Telegram && window.Telegram.WebApp) {
            console.log('🚀 Telegram WebApp detected, initializing…');
            
            const tg = window.Telegram.WebApp;
            
            // Initialize with ready callback
            tg.ready(() => {
              console.log('📱 Telegram WebApp ready callback triggered');
              
              // Expand the app
              tg.expand();
              
              // Set theme colors
              if (tg.setHeaderColor) {
                tg.setHeaderColor('#0b0f1a');
                console.log('🎨 Telegram header color set');
              }
              if (tg.setBackgroundColor) {
                tg.setBackgroundColor('#0b0f1a');
                console.log('🎨 Telegram background color set');
              }
              
              // Enable haptic feedback
              if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
                console.log('📱 Haptic feedback enabled');
              }
              
              // Log Telegram user data for debugging
              if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                console.log('👤 Telegram User detected:', {
                  id: tg.initDataUnsafe.user.id,
                  username: tg.initDataUnsafe.user.username,
                  first_name: tg.initDataUnsafe.user.first_name
                });
              } else {
                console.log('⚠️ No Telegram user data found - running in web browser mode');
              }
              
              console.log('✅ Telegram WebApp initialized successfully');
              window.telegramReady = true;
            });
            
          } else {
            console.log('🌐 Running in web browser mode (no Telegram WebApp)');
            window.telegramReady = false;
          }
        } catch (error) {
          console.error('❌ Telegram initialization error:', error);
          window.telegramReady = false;
        }
      }
      
      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeTelegram);
      } else {
        initializeTelegram();
      }
      
      // FIX: Sample Tasks Initialization
      window.addEventListener('firebaseReady', function() {
        console.log('🔥 Firebase ready, initializing sample data...');
        
        // Sample tasks for immediate availability
        const SAMPLE_TASKS = [
          {
            title: "Welcome to Mining PRO! 🎯",
            description: "Complete your first task to get started! Click 'Claim Reward' to earn your first coins.",
            reward: 100,
            type: "daily",
            icon: "🎯",
            active: true,
            verification: "auto"
          },
          {
            title: "Join Our Telegram Channel 📢",
            description: "Join our official Telegram channel for updates and exclusive content.",
            reward: 250,
            type: "channel_join",
            icon: "📢",
            url: "https://t.me/Mining_tech_bot",
            active: true,
            verification: "manual"
          },
          {
            title: "Follow on YouTube 🎥",
            description: "Subscribe to our YouTube channel and ring the notification bell.",
            reward: 300,
            type: "youtube",
            icon: "🎥",
            url: "https://youtube.com/@miningtechbot",
            active: true,
            verification: "manual"
          },
          {
            title: "Daily Login Bonus 📅",
            description: "Login daily to claim your bonus rewards. Streak multiplier applies!",
            reward: 50,
            type: "daily",
            icon: "📅",
            active: true,
            verification: "auto"
          },
          {
            title: "Weekly Mining Challenge ⛏️",
            description: "Complete 7 days of continuous mining to earn this special reward.",
            reward: 1000,
            type: "weekly",
            icon: "⛏️",
            active: true,
            verification: "auto"
          },
          {
            title: "Special Launch Bonus 🚀",
            description: "Limited time offer! Claim your special launch bonus now.",
            reward: 500,
            type: "special",
            icon: "🚀",
            active: true,
            verification: "auto",
            expiresAt: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days from now
          }
        ];
        
        // Initialize sample tasks if none exist
        setTimeout(async () => {
          try {
            const tasksRef = window.firebaseRef(window.database, 'tasks');
            const snapshot = await window.firebaseGet(tasksRef);
            
            if (!snapshot.exists()) {
              console.log('📝 No tasks found, creating sample tasks...');
              
              for (const task of SAMPLE_TASKS) {
                const newTaskRef = window.firebasePush(tasksRef);
                await window.firebaseSet(newTaskRef, {
                  ...task,
                  id: newTaskRef.key,
                  createdAt: Date.now()
                });
                console.log(`✅ Added sample task: ${task.title}`);
              }
              
              console.log('🎉 Sample tasks created successfully');
            } else {
              console.log('📋 Tasks already exist, skipping sample creation');
            }
          } catch (error) {
            console.error('❌ Failed to initialize sample tasks:', error);
          }
        }, 2000);
      });
      
      // Enhanced debugging utilities
      window.debugApp = function() {
        console.log('🔍 App Debug Info:');
        console.log('- Firebase connected:', window.firebaseConnected);
        console.log('- Firebase app:', window.firebaseApp);
        console.log('- Database:', window.database);
        console.log('- Telegram WebApp available:', !!window.Telegram?.WebApp);
        console.log('- Telegram ready:', window.telegramReady);
        console.log('- React app mounted:', !document.getElementById('loading-screen'));
        console.log('- User agent:', navigator.userAgent);
        console.log('- Current URL:', window.location.href);
      };
      
      // Auto-retry Firebase connection if it fails
      let firebaseRetryCount = 0;
      const maxFirebaseRetries = 5;
      
      window.addEventListener('firebaseReady', () => {
        firebaseRetryCount = 0; // Reset on successful connection
      });
      
      // Monitor Firebase connection and retry if needed
      setInterval(() => {
        if (!window.firebaseConnected && firebaseRetryCount < maxFirebaseRetries) {
          firebaseRetryCount++;
          console.log(`🔄 Firebase connection retry ${firebaseRetryCount}/${maxFirebaseRetries}`);
          
          // Attempt to reinitialize Firebase connection
          try {
            const connectedRef = window.firebaseRef(window.database, '.info/connected');
            window.firebaseOnValue(connectedRef, (snapshot) => {
              if (snapshot.val() === true) {
                console.log('✅ Firebase reconnected successfully');
                window.firebaseConnected = true;
                window.dispatchEvent(new CustomEvent('firebaseReady'));
              }
            });
          } catch (error) {
            console.error('❌ Firebase retry failed:', error);
          }
        }
      }, 5000); // Check every 5 seconds
      
      // Make hideLoadingScreen globally available for React app
      window.hideLoadingScreen = hideLoadingScreen;
      
      // Enhanced hideLoadingScreen that also clears timeout
      const originalHideLoadingScreen = hideLoadingScreen;
      window.hideLoadingScreen = function() {
        if (window.clearLoadingTimeout) {
          window.clearLoadingTimeout();
        }
        originalHideLoadingScreen();
      };
    </script>
  </body>
</html>