<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CRYPTO FARMING</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        /* --- Global Styles & Dark Theme --- */
        :root {
            --bg-color: #121212;
            --primary-surface: #1e1e1e;
            --secondary-surface: #2a2a2a;
            --primary-accent: #f0b90b;
            --secondary-accent: #4caf50;
            --primary-text: #ffffff;
            --secondary-text: #b0b0b0;
            --danger-color: #f44336;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center;
            align-items: center; z-index: 9999; font-size: 1.5em;
        }

        /* --- Main App Container --- */
        #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        
        /* Header & Main Content */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--primary-surface); border-bottom: 1px solid var(--secondary-surface); }
        .profile-info { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .coin-balance { font-size: 1.2em; font-weight: bold; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 15px; position: relative; }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Farming Tab */
        #farming-tab { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; gap: 20px; }
        .farm-logo { width: 150px; height: 150px; border-radius: 50%; border: 5px solid var(--primary-accent); box-shadow: 0 0 20px var(--primary-accent); }
        .progress-bar-container { width: 80%; background-color: var(--secondary-surface); border-radius: 10px; padding: 3px; }
        .progress-bar { width: 0%; height: 10px; background-color: var(--secondary-accent); border-radius: 8px; transition: width 1s linear; }
        #farm-timer { font-size: 1.1em; color: var(--secondary-text); }
        #farm-button { padding: 15px 40px; font-size: 1.2em; font-weight: bold; border: none; border-radius: 12px; background-color: var(--primary-accent); color: var(--bg-color); cursor: pointer; transition: transform 0.2s; }
        #farm-button:disabled { background-color: var(--secondary-surface); color: var(--secondary-text); cursor: not-allowed; }
        #farm-button:active { transform: scale(0.95); }
        
        /* Animations */
        #falling-leaves-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: -1; }
        .leaf { position: absolute; top: -10%; font-size: 1.5em; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        #level-up-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5); background: var(--primary-surface); padding: 40px; border-radius: 20px; text-align: center; z-index: 1000; border: 2px solid var(--primary-accent); opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none; }
        #level-up-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all; }
        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; }
        
        /* Common UI Elements */
        .task-list, .history-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item, .history-item { background: var(--primary-surface); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .task-info, .history-info { flex-grow: 1; }
        button, .task-item button, .form-container button { padding: 10px 18px; background: var(--primary-accent); color: var(--bg-color); border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; }
        .form-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; background-color: var(--primary-surface); padding: 20px; border-radius: 12px;}
        .form-container input, .form-container select, .form-container textarea { padding: 12px; border-radius: 8px; border: 1px solid var(--secondary-surface); background-color: var(--bg-color); color: var(--primary-text); font-size: 1em; }
        
        /* Navigation Bar */
        .nav-bar { display: flex; justify-content: space-around; background-color: var(--primary-surface); padding: 10px 0; border-top: 1px solid var(--secondary-surface); }
        .nav-item { cursor: pointer; padding: 5px 15px; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; text-align: center; }
        .nav-item.active { opacity: 1; transform: scale(1.1); color: var(--primary-accent); }

        /* --- Admin Panel --- */
        #admin-panel { padding: 20px; background-color: var(--bg-color); color: var(--primary-text); height: 100vh; overflow-y: auto; box-sizing: border-box; }
        #admin-login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { background: var(--primary-surface); padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); text-align: center; width: 300px; }
        .login-box input { display: block; width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid var(--secondary-surface); background-color: var(--bg-color); color: var(--primary-text); font-size: 1em; box-sizing: border-box;}
        .login-box button { width: 100%; }
        .admin-section { background: var(--primary-surface); padding: 20px; margin-bottom: 20px; border-radius: 12px; }
        .admin-section h3 { margin-top: 0; border-bottom: 1px solid var(--primary-accent); padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center; }
        .stat-card { background-color: var(--secondary-surface); padding: 20px; border-radius: 10px; }
        .stat-card h4 { margin: 0 0 10px 0; color: var(--secondary-text); }
        .stat-card p { margin: 0; font-size: 1.8em; font-weight: bold; color: var(--primary-accent); }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { border: 1px solid var(--secondary-surface); padding: 12px; text-align: left; }
        .admin-table th { background-color: var(--secondary-surface); }
        .admin-table button { padding: 6px 12px; font-size: 0.9em; margin-right: 5px; }
        .btn-danger { background-color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="loader">Loading... 💰</div>

    <div id="app-container" class="hidden">
        <header class="header">
            <div id="coin-balance-container" class="coin-balance">💰 0</div>
            <div class="profile-info">
                <span id="user-name">User</span>
                <img id="user-pic" class="profile-pic" src="https://t.me/i/userpic/320/1.jpg" alt="P">
            </div>
        </header>
        <main class="main-content">
            <div id="farming-tab" class="tab-content">
                <div id="falling-leaves-container"></div>
                <h2>CRYPTO FARMING</h2>
                <div id="logo-container"><img src="https://envs.sh/Gt3.jpg/IMG2025092696.jpg" alt="Crypto Farm Logo" class="farm-logo"></div>
                <div class="progress-bar-container"><div class="progress-bar" id="farm-progress"></div></div>
                <span id="farm-timer">Ready to farm!</span>
                <button id="farm-button">Start Farming</button>
            </div>
            <div id="tasks-tab" class="tab-content hidden">
                <h2>Complete Tasks for Rewards</h2>
                <div id="tasks-list-container" class="task-list">
                    <div class="task-item">
                        <div class="task-info"><h4>📺 Watch Ad</h4><p>Watch a short ad to earn coins.</p></div>
                        <button onclick="alert('Ad feature coming soon!')">Watch</button>
                    </div>
                </div>
            </div>
            <div id="referral-tab" class="tab-content hidden">
                 <h2>Refer & Earn</h2>
                <div class="form-container">
                    <p>Share your link to earn coins for every friend who joins!</p>
                    <input type="text" id="referral-link" readonly>
                    <button onclick="copyReferralLink()">Copy Link</button>
                </div>
                 <h3>Your Referrals</h3>
                <div id="referral-history-list" class="history-list"><p>No referrals yet.</p></div>
            </div>
            <div id="exchange-tab" class="tab-content hidden">
                <h2>Exchange & Withdraw</h2>
                <div class="form-container">
                    <h4>Convert Coins</h4>
                    <p id="conversion-rate">Conversion Rate: 1000 💰 = 1 INR</p>
                    <input type="number" id="convert-amount" placeholder="Enter coin amount">
                    <button onclick="convertCoins()">Convert</button>
                    <h4 style="margin-top: 20px;">Request Withdrawal</h4>
                    <select id="withdrawal-method"><option value="upi">UPI</option><option value="usdt">USDT (TRC20)</option></select>
                    <input type="text" id="withdrawal-address" placeholder="Enter UPI ID or USDT Address">
                    <input type="number" id="withdrawal-amount" placeholder="Enter INR/USDT amount">
                    <button onclick="requestWithdrawal()">Request</button>
                </div>
                <h3>Withdrawal History</h3>
                 <div id="withdrawal-history-list" class="history-list"><p>No withdrawal history.</p></div>
            </div>
            <div id="profile-tab" class="tab-content hidden">
                <h2>My Profile</h2>
                <div class="task-list">
                    <div class="task-item"><span>User ID</span> <strong id="profile-userid">...</strong></div>
                    <div class="task-item"><span>Total Coins</span> <strong id="profile-coins">...</strong></div>
                    <div class="task-item"><span>Total Exchanged</span> <strong id="profile-exchanged">...</strong></div>
                    <div class="task-item"><span>Referrals</span> <strong id="profile-referrals">...</strong></div>
                    <div class="task-item"><span>Current Level</span> <strong id="profile-level">...</strong></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <div class="nav-item active" data-tab="farming-tab">🏠<br>Farm</div>
            <div class="nav-item" data-tab="tasks-tab">📋<br>Tasks</div>
            <div class="nav-item" data-tab="referral-tab">👥<br>Refer</div>
            <div class="nav-item" data-tab="exchange-tab">💸<br>Exchange</div>
            <div class="nav-item" data-tab="profile-tab">👤<br>Profile</div>
        </nav>
        <div id="level-up-popup">
            <div id="confetti-container"></div>
            <h2>LEVEL UP!</h2><p>You've reached <strong id="new-level">Level X</strong>!</p><p>🎉 Rewards Unlocked! 🎉</p>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <div id="admin-login-screen">
            <div class="login-box">
                <h2>CRYPTO FARMING - Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Email" value="admin@gmail.com">
                <input type="password" id="admin-password" placeholder="Password" value="admin123">
                <button onclick="handleAdminLogin()">Login</button>
                <p id="admin-login-error" style="color:red;"></p>
            </div>
        </div>

        <div id="admin-dashboard" class="hidden">
            <h2>Admin Dashboard</h2>
            <div class="admin-section">
                <h3>Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-card"><h4>Total Users</h4><p id="stats-total-users">0</p></div>
                    <div class="stat-card"><h4>Total Coins in Circulation</h4><p id="stats-total-coins">0</p></div>
                    <div class="stat-card"><h4>Pending Withdrawals</h4><p id="stats-pending-withdrawals">0</p></div>
                </div>
            </div>

            <div class="admin-section">
                <h3>Task Management</h3>
                <div class="form-container">
                    <input type="hidden" id="task-id">
                    <input type="text" id="task-name" placeholder="Task Name (e.g., Join Our Channel)">
                    <input type="number" id="task-reward" placeholder="Reward (Coins)">
                    <select id="task-type">
                        <option value="join_channel">Join Channel</option>
                        <option value="join_group">Join Group</option>
                        <option value="visit_link">Visit Link</option>
                        <option value="youtube_video">YouTube Video (Key)</option>
                    </select>
                    <input type="text" id="task-link" placeholder="Telegram/YouTube Link">
                    <input type="text" id="task-key" placeholder="Secret Key (for YouTube only)">
                    <button id="add-task-btn" onclick="handleSaveTask()">Add Task</button>
                </div>
                <table class="admin-table" id="tasks-table">
                    <thead><tr><th>Name</th><th>Reward</th><th>Type</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="admin-section">
                <h3>Withdrawal Requests</h3>
                <table class="admin-table" id="withdrawal-requests-table">
                    <thead><tr><th>User ID</th><th>Amount</th><th>Method</th><th>Address</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

             <div class="admin-section">
                <h3>Global Settings</h3>
                 <div class="form-container">
                    <label>Farming Rate (coins/min):</label> <input type="number" id="setting-farm-rate">
                    <label>Conversion Rate (Coins per 1 INR/USDT):</label> <input type="number" id="setting-conversion-rate">
                    <button onclick="saveAdminSettings()">Save Settings</button>
                 </div>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyBWhjcgCmp5A6V5uCSSB-j8yMKqRYZuHIY",
            authDomain: "mining-bot-6131b.firebaseapp.com",
            projectId: "mining-bot-6131b",
            storageBucket: "mining-bot-6131b.firebasestorage.app",
            messagingSenderId: "614776449697",
            appId: "1:614776449697:web:a13c41c86b4aa16b2adee0"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('loader').innerText = "Firebase Config Missing!";
            return;
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const tg = window.Telegram.WebApp;

        let currentUser = null;
        let userData = null;
        let farmInterval = null;
        
        // Firestore Security Rules (for reference, apply these in your Firebase Console)
        /*
        -- !! IMPORTANT SECURITY WARNING !! --
        -- These rules are for DEVELOPMENT ONLY. They allow anyone to read/write. --
        -- For a real app, you MUST implement secure rules with server-side validation. --
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /{document=**} {
              allow read, write: if true;
            }
          }
        }
        */

        async function initializeApp() {
            try {
                await auth.signInAnonymously();
                console.log("Signed in anonymously to Firebase.");

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    tg.ready();
                    tg.expand();
                    currentUser = tg.initDataUnsafe.user;
                    document.getElementById('app-container').classList.remove('hidden');
                    await initUserPanel();
                } else {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('admin-login-screen').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Initialization or Auth Error:", error);
                document.getElementById('loader').innerText = "Error loading app.";
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        }

        // --- USER PANEL LOGIC --- //
        async function initUserPanel() {
            document.getElementById('user-name').innerText = currentUser.first_name;
            if (currentUser.photo_url) document.getElementById('user-pic').src = currentUser.photo_url;
            await loadUserData();
            await loadUserTasks();
            setupEventListeners();
        }

        async function loadUserData() {
            const userId = currentUser.id.toString();
            const userRef = db.collection('users').doc(userId);
            const doc = await userRef.get();
            if (doc.exists) {
                userData = doc.data();
            } else {
                userData = {
                    id: userId, username: currentUser.username || 'N/A', firstName: currentUser.first_name,
                    coins: 0, xp: 0, level: 1, farmingStartTime: null,
                    farmingDuration: 24 * 60 * 60 * 1000, referrals: [], exchangedTotal: 0, completedTasks: []
                };
                await userRef.set(userData);
            }
            localStorage.setItem(`userData_${userId}`, JSON.stringify(userData));
            updateUI();
        }
        
        async function loadUserTasks() {
            const tasksSnapshot = await db.collection('tasks').get();
            const container = document.getElementById('tasks-list-container');
            // Clear previous tasks except the static ad task
            container.innerHTML = `
                <div class="task-item">
                    <div class="task-info"><h4>📺 Watch Ad</h4><p>Watch a short