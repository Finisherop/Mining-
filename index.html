<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Farming Booster App</title>
    <link rel="icon" href="https://ibb.co.com/yvLVD3j" type="image/jpeg">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <style>
        /* --- Global Styles & Dark Theme --- */
        :root {
            --bg-color: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b69 100%);
            --primary-surface: rgba(30, 30, 30, 0.9);
            --secondary-surface: rgba(42, 42, 42, 0.8);
            --primary-accent: #00d4ff;
            --secondary-accent: #4caf50;
            --primary-text: #ffffff;
            --secondary-text: #b0b0b0;
            --danger-color: #f44336;
            --font-family: 'Helvetica Neue', Arial, sans-serif;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
* {
  -webkit-tap-highlight-color: transparent;
}

        body {
            font-family: var(--font-family);
            background: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://i.ibb.co/j9WqyNWT/IMG-20250925-233648-989.jpg') center/cover;
            opacity: 0.1;
            z-index: -1;
            animation: bgFloat 20s ease-in-out infinite;
        }
        
        @keyframes bgFloat {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.05) rotate(1deg); }
        }
        .hidden { display: none !important; }
        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; justify-content: center;
            align-items: center; z-index: 9999; font-size: 1.5em;
        }
        /* --- Main App Container --- */
        #app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }
        /* --- Header --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: var(--primary-surface);
            border-bottom: 1px solid var(--secondary-surface);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 212, 255, 0.1);
        }
        .balance-container {
             text-align: left;
        }
        .coin-balance { 
            font-size: 1.3em; font-weight: bold; 
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: coinGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes coinGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }
        #farming-rate-display { font-size: 0.8em; color: var(--secondary-text); }
        .profile-info { display: flex; align-items: center; gap: 10px; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1; overflow-y: auto; padding: 15px; position: relative;
        }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* --- Farming Tab --- */
        #farming-tab {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            text-align: center; height: 100%; gap: 15px; padding: 10px;
        }
        #logo-container { position: relative; }
        .farm-logo {
            width: 120px; height: 120px; border-radius: 50%;
            border: 4px solid var(--primary-accent); box-shadow: 0 0 15px var(--primary-accent);
            background: url('https://i.ibb.co/j9WqyNWT/IMG-20250925-233648-989.jpg') center/cover;
        }
        .progress-bar-container {
            width: 80%; background-color: var(--secondary-surface); border-radius: 10px; padding: 3px;
        }
        .progress-bar {
            width: 0%; height: 10px; background-color: var(--secondary-accent);
            border-radius: 8px; transition: width 1s linear;
        }
        #farm-timer { font-size: 1.1em; color: var(--secondary-text); }
        #farm-button {
            padding: 15px 35px; font-size: 1.2em; font-weight: bold; border: none;
            border-radius: 25px; background: var(--gradient-primary);
            color: white; cursor: pointer; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            position: relative;
            overflow: hidden;
        }
        #farm-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        #farm-button:hover:before {
            left: 100%;
        }
        #farm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }
        #farm-button:disabled {
            background: var(--secondary-surface); 
            color: var(--secondary-text); 
            cursor: not-allowed;
            box-shadow: none;
        }
        #farm-button:active { transform: scale(0.95); }
        
        /* Booster Display */
        .booster-display {
            background: var(--gradient-secondary); 
            padding: 15px; border-radius: 15px;
            margin: 10px 0; border: 2px solid transparent;
            text-align: center; font-weight: bold;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
            animation: boosterPulse 2s ease-in-out infinite;
        }
        .booster-display.active { 
            border-color: var(--primary-accent);
            animation: boosterActive 1s ease-in-out infinite alternate;
        }
        
        @keyframes boosterPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes boosterActive {
            0% { box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3); }
            100% { box-shadow: 0 6px 25px rgba(240, 147, 251, 0.6); }
        }
        
        /* Daily Claim Calendar */
        .daily-claim-section {
            width: 100%; max-width: 300px; margin: 10px 0;
        }
        .claim-calendar {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;
            margin-top: 10px;
        }
        .claim-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: var(--secondary-surface); border-radius: 8px; font-size: 0.8em;
            border: 2px solid transparent; cursor: pointer; transition: all 0.2s;
        }
        .claim-day.claimed { background: var(--secondary-accent); color: var(--bg-color); }
        .claim-day.today { border-color: var(--primary-accent); }
        .claim-day.available { background: var(--primary-accent); color: var(--bg-color); animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .daily-claim-button {
            background: var(--gradient-success) !important;
            color: white !important;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            animation: claimPulse 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        @keyframes claimPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(76, 175, 80, 0.5); }
        }
        
        /* --- Booster Shop --- */
        .booster-grid {
            display: grid; grid-template-columns: 1fr; gap: 15px; padding: 10px;
        }
        .booster-card {
            background: var(--primary-surface); border-radius: 12px; padding: 20px;
            border: 2px solid var(--secondary-surface); transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        .booster-card:hover { border-color: var(--primary-accent); transform: translateY(-2px); }
        .booster-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .booster-multiplier {
            font-size: 1.5em; font-weight: bold; color: var(--primary-accent);
        }
        .booster-duration {
            font-size: 0.9em; color: var(--secondary-text);
        }
        .booster-buttons {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .booster-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        .booster-btn.stars {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: var(--bg-color);
        }
        .booster-btn.upi {
            background: linear-gradient(45deg, #4CAF50, #2E7D32);
            color: white;
        }
        .booster-btn:hover { transform: scale(1.05); }
        .booster-btn:active { transform: scale(0.95); }
        
        /* UPI Payment Popup */
        .upi-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--primary-surface); padding: 30px; border-radius: 15px;
            border: 2px solid var(--primary-accent); z-index: 1000; width: 90%; max-width: 400px;
            display: none;
        }
        .upi-popup.show { display: block; }
        .upi-popup h3 { margin-top: 0; color: var(--primary-accent); }
        .upi-popup input {
            width: calc(100% - 20px); padding: 10px; margin: 10px 0;
            border: 1px solid var(--secondary-surface); border-radius: 8px;
            background: var(--bg-color); color: var(--primary-text);
        }
        .upi-popup .popup-buttons {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .upi-popup button {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer;
        }
        .popup-submit { background: var(--secondary-accent); color: white; }
        .popup-cancel { background: var(--danger-color); color: white; }

        /* --- Level Up Popup --- */
        #level-up-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            background: var(--primary-surface); padding: 40px; border-radius: 20px;
            text-align: center; z-index: 1000; border: 2px solid var(--primary-accent);
            opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none;
        }
        #level-up-popup.show {
            opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: all;
        }
        #confetti-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none;
        }
        /* --- General Task/List Styles --- */
        .task-list, .history-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item, .history-item {
            background: var(--primary-surface); padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .task-info, .history-info { flex-grow: 1; }
        .task-item button, .form-container button, .admin-section button {
            padding: 8px 15px; background: var(--primary-accent); color: var(--primary-text);
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .task-item button:disabled { background: var(--secondary-surface); color: var(--secondary-text); }
        .form-container { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .form-container input, .form-container select {
            padding: 12px; border-radius: 8px; border: 1px solid var(--secondary-surface);
            background-color: var(--bg-color); color: var(--primary-text); font-size: 1em;
        }
        /* --- Navigation Bar --- */
        .nav-bar {
            display: flex; justify-content: space-around; 
            background: var(--primary-surface);
            padding: 10px 0; border-top: 1px solid var(--secondary-surface);
            backdrop-filter: blur(10px);
            box-shadow: 0 -2px 20px rgba(0, 212, 255, 0.1);
        }
        .nav-item {
            cursor: pointer; padding: 8px 12px; opacity: 0.7;
            transition: all 0.3s ease; text-align: center;
            border-radius: 12px; position: relative;
        }
        .nav-item:hover {
            opacity: 0.9;
            background: rgba(0, 212, 255, 0.1);
        }
        .nav-item.active { 
            opacity: 1; 
            transform: translateY(-2px); 
            color: var(--primary-accent);
            background: var(--gradient-primary);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        /* --- Admin Panel --- */
        #admin-panel {
            padding: 20px; background: #1c1c1e; color: #f5f5f7; height: 100vh; overflow-y: auto;
        }
        #admin-login-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        .login-box {
            background: #2c2c2e; padding: 30px; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); text-align: center;
        }
        .login-box input {
            display: block; width: calc(100% - 20px); padding: 10px; margin: 10px auto;
            border: 1px solid #444; border-radius: 5px; background: #3a3a3c; color: #f5f5f7;
        }
        .login-box button {
            width: 100%; padding: 10px; background: #0a84ff; color: white;
            border: none; border-radius: 5px; cursor: pointer;
        }
        .admin-section {
            background: #2c2c2e; padding: 20px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .admin-section h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .admin-section input, .admin-section select, .admin-section textarea {
            width: calc(100% - 20px); padding: 8px; margin-top: 5px;
            background: #3a3a3c; color: #f5f5f7; border: 1px solid #444; border-radius: 4px;
        }
        .admin-section label { display: block; margin-top: 10px; font-size: 0.9em; color: #aaa; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td {
            border: 1px solid #444; padding: 8px; text-align: left;
        }
        .admin-table th { background: #3a3a3c; }
        .admin-table button { padding: 5px 10px; font-size: 0.9em; margin-right: 5px; }
        .stat-card-container { display: flex; gap: 15px; flex-wrap: wrap; }
        .stat-card {
            flex-grow: 1; background: #3a3a3c; padding: 15px; border-radius: 8px; text-align: center;
        }
        .stat-card h4 { margin: 0 0 5px 0; color: #aaa; }
        .stat-card p { margin: 0; font-size: 1.5em; font-weight: bold; }
    </style>
</head>
<body>
    <div id="loader">Loading... üí∞</div>
    <div id="app-container" class="hidden">
        <header class="header">
            <div class="balance-container">
                 <div id="coin-balance-container" class="coin-balance">üí∞ 0</div>
                 <small id="farming-rate-display">...</small>
            </div>
            <div class="profile-info">
                <span id="user-name">User</span>
                <img id="user-pic" class="profile-pic" src="https://t.me/i/userpic/320/1.jpg" alt="P">
            </div>
        </header>
        <main class="main-content">
            <div id="farming-tab" class="tab-content">
                <h2>üåæ FARMING BOOSTER</h2>
                
                <!-- Active Booster Display -->
                <div id="active-booster-display" class="booster-display hidden">
                    <div>üöÄ <span id="booster-multiplier-text">2.0X</span> Boost Active</div>
                    <div id="booster-timer">10h 30m left</div>
                </div>
                
                <div id="logo-container">
                    <div class="farm-logo"></div>
                </div>
                
                <!-- Daily Claim Calendar -->
                <div class="daily-claim-section">
                    <h4>üìÖ Daily Claim Calendar</h4>
                    <div class="claim-calendar" id="claim-calendar">
                        <!-- Calendar days will be generated by JavaScript -->
                    </div>
                    <button id="daily-claim-btn" class="hidden daily-claim-button" onclick="handleDailyClaim()">
                        üéÅ Claim Daily Reward!
                    </button>
                </div>
                
                <div class="progress-bar-container">
                    <div class="progress-bar" id="farm-progress"></div>
                </div>
                <span id="farm-timer">Ready to farm!</span>
                <button id="farm-button">Start Farming</button>
            </div>
            <div id="shop-tab" class="tab-content hidden">
                <h2>üõçÔ∏è Booster Shop</h2>
                <div id="booster-list" class="booster-grid">
                    <p>Loading boosters...</p>
                </div>
            </div>
            <div id="tasks-tab" class="tab-content hidden">
                <h2>Complete Tasks for Rewards</h2>
                <div id="task-list-dynamic" class="task-list">
                    </div>
            </div>
            <div id="referral-tab" class="tab-content hidden">
                 <h2>Refer & Earn</h2>
                <div class="form-container">
                    <p>Share your link! You earn 500 üí∞ for every friend who joins.</p>
                    <input type="text" id="referral-link" readonly>
                    <button onclick="copyReferralLink()">Copy Link</button>
                </div>
                 <h3>Your Referrals</h3>
                <div id="referral-history-list" class="history-list">
                    <p>No referrals yet.</p>
                </div>
            </div>
            <div id="withdrawal-tab" class="tab-content hidden">
                <h2>üí∏ Withdrawal</h2>
                <div class="form-container">
                    <h4>Convert Coins to INR</h4>
                    <p id="conversion-rate">Loading rate...</p>
                    <input type="number" id="convert-amount" placeholder="Enter coin amount">
                    <button onclick="convertCoins()">Convert to INR</button>
                    <h4 style="margin-top: 20px;">Request UPI Withdrawal</h4>
                    <input type="number" id="withdrawal-amount" placeholder="Enter INR amount">
                    <input type="text" id="withdrawal-upi" placeholder="Enter UPI ID">
                    <input type="text" id="withdrawal-name" placeholder="Enter Full Name">
                    <button onclick="requestWithdrawal()">Request Withdrawal</button>
                </div>
                <h3>Withdrawal History</h3>
                 <div id="withdrawal-history-list" class="history-list">
                     <p>No withdrawal history.</p>
                 </div>
            </div>
            <div id="profile-tab" class="tab-content hidden">
                <h2>My Profile</h2>
                <div class="task-list">
                    <div class="task-item"><span>User ID</span> <strong id="profile-userid">...</strong></div>
                    <div class="task-item"><span>Total Coins</span> <strong id="profile-coins">...</strong></div>
                    <div class="task-item"><span>Total Exchanged (INR)</span> <strong id="profile-exchanged">...</strong></div>
                    <div class="task-item"><span>Referrals</span> <strong id="profile-referrals">...</strong></div>
                    <div class="task-item"><span>Current Level</span> <strong id="profile-level">...</strong></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <div class="nav-item active" data-tab="farming-tab">üè†<br>Farm</div>
            <div class="nav-item" data-tab="shop-tab">üõçÔ∏è<br>Shop</div>
            <div class="nav-item" data-tab="tasks-tab">üìã<br>Tasks</div>
            <div class="nav-item" data-tab="referral-tab">üë•<br>Refer</div>
            <div class="nav-item" data-tab="withdrawal-tab">üí∏<br>Withdraw</div>
            <div class="nav-item" data-tab="profile-tab">üë§<br>Profile</div>
        </nav>
        <div id="level-up-popup">
            <div id="confetti-container"></div>
            <h2>LEVEL UP!</h2>
            <p>You've reached <strong id="new-level">Level X</strong>!</p>
            <p>üéâ Rewards Unlocked! üéâ</p>
        </div>
        
        <!-- UPI Payment Popup -->
        <div id="upi-popup" class="upi-popup">
            <h3>üí≥ UPI Payment</h3>
            <p>Pay to Admin UPI ID:</p>
            <div style="background: var(--secondary-surface); padding: 10px; border-radius: 8px; margin: 10px 0;">
                <strong id="admin-upi-display">Loading...</strong>
            </div>
            <p>Amount: ‚Çπ<span id="upi-amount-display">0</span></p>
            <p>After payment, enter your transaction ID (UTR):</p>
            <input type="text" id="upi-transaction-id" placeholder="Enter Transaction ID/UTR">
            <div class="popup-buttons">
                <button class="popup-cancel" onclick="closeUPIPopup()">Cancel</button>
                <button class="popup-submit" onclick="submitUPIPayment()">Submit</button>
            </div>
        </div>
    </div>
    <div id="admin-panel" class="hidden">
        <div id="admin-login-screen">
            <div class="login-box">
                <h2>FARMING BOOSTER - Admin Login</h2>
                <input type="email" id="admin-email" placeholder="Email" value="admin@gmail.com">
                <input type="password" id="admin-password" placeholder="Password" value="admin123">
                <button onclick="handleAdminLogin()">Login</button>
                <p id="admin-login-error" style="color:red;"></p>
            </div>
        </div>
        <div id="admin-dashboard" class="hidden">
            <h2>Admin Dashboard</h2>
            <div class="admin-section">
                <h3>Dashboard Stats</h3>
                <div class="stat-card-container">
                    <div class="stat-card"><h4>Total Users</h4><p id="stats-total-users">0</p></div>
                    <div class="stat-card"><h4>Total Coins in Circulation</h4><p id="stats-total-coins">0</p></div>
                    <div class="stat-card"><h4>Pending Withdrawals</h4><p id="stats-pending-withdrawals">0</p></div>
                </div>
            </div>
            <div class="admin-section">
                <h3>Task Management</h3>
                <input type="hidden" id="task-id-input">
                <label>Task Name</label><input type="text" id="task-name-input" placeholder="e.g., Join Our Community">
                <label>Task Reward (Coins)</label><input type="number" id="task-reward-input" placeholder="e.g., 200">
                <label>Task Type</label>
                <select id="task-type-input">
                    <option value="visit_link">Visit Link</option>
                    <option value="join_channel">Join Telegram Channel</option>
                    <option value="join_group">Join Telegram Group</option>
                    <option value="youtube_video">YouTube Video (with key)</option>
                </select>
                <label>Task Link (URL)</label><input type="url" id="task-link-input" placeholder="https://t.me/channel or https://youtu.be/...">
                <div id="task-key-container" class="hidden">
                    <label>YouTube Secret Key</label><input type="text" id="task-key-input" placeholder="e.g., SECRET123">
                </div>
                <button onclick="saveAdminTask()" style="margin-top:15px;">Save Task</button>
                <h4 style="margin-top: 20px;">Existing Tasks</h4>
                <table id="tasks-table" class="admin-table">
                    <thead><tr><th>Name</th><th>Reward</th><th>Type</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-section">
                <h3>Booster Management</h3>
                <input type="hidden" id="booster-id-input">
                <label>Multiplier (e.g., 2.0):</label><input type="number" step="0.1" id="booster-multiplier-input">
                <label>Duration (minutes):</label><input type="number" id="booster-duration-input">
                <label>Star Price:</label><input type="number" id="booster-star-price-input">
                <label>UPI Price (INR):</label><input type="number" id="booster-upi-price-input">
                <button onclick="saveBooster()" style="margin-top:15px;">Save Booster</button>
                <h4 style="margin-top: 20px;">Existing Boosters</h4>
                <table id="boosters-table" class="admin-table">
                    <thead><tr><th>Multiplier</th><th>Duration</th><th>Star Price</th><th>UPI Price</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-section">
                <h3>UPI Payment Approvals</h3>
                <table id="upi-pending-table" class="admin-table">
                    <thead><tr><th>User</th><th>Booster</th><th>Amount</th><th>UTR</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="admin-section">
                <h3>Global Settings</h3>
                <label>Farming Rate (coins/min):</label><input type="number" id="setting-farm-rate">
                <label>Daily Claim Reward:</label><input type="number" id="setting-daily-reward">
                <label>INR Exchange Rate (Coins per 1 INR):</label><input type="number" id="setting-inr-rate">
                <label>Admin UPI ID:</label><input type="text" id="setting-admin-upi">
                <br><br>
                <button onclick="saveAdminSettings()">Save Settings</button>
            </div>
            <div class="admin-section">
                <h3>Withdrawal Requests</h3>
                <table id="withdrawal-requests-table" class="admin-table">
                    <thead><tr><th>User ID</th><th>Amount (INR)</th><th>UPI ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
             <div class="admin-section">
                <h3>Broadcast Message</h3>
                <textarea id="broadcast-message" rows="4"></textarea>
                <button onclick="sendBroadcast()">Send to All Users</button>
            </div>
        </div>
    </div>
    <script>
    // --- JAVASCRIPT LOGIC --- //
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration --- //
        const firebaseConfig = {
            apiKey: "AIzaSyBWhjcgCmp5A6V5uCSSB-j8yMKqRYZuHIY",
            authDomain: "mining-bot-6131b.firebaseapp.com",
            projectId: "mining-bot-6131b",
            storageBucket: "mining-bot-6131b.appspot.com",
            messagingSenderId: "614776449697",
            appId: "1:614776449697:web:a13c41c86b4aa16b2adee0"
        };
        // --- Firebase Initialization --- //
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase initialization failed. Make sure you have pasted your config object.", e);
            document.getElementById('loader').innerText = "Firebase Config Missing!";
            return;
        }
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        // --- Global Variables --- //
        let currentUser = null;
        let userData = null;
        let farmInterval = null;
        let globalSettings = {};

        async function initializeApp() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe.user;
                document.getElementById('app-container').classList.remove('hidden');
                await initUserPanel();
            } else {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-login-screen').classList.remove('hidden');
            }
            document.getElementById('loader').classList.add('hidden');
        }

        
        // --- USER PANEL LOGIC --- //
        async function initUserPanel() {
            document.getElementById('user-name').innerText = currentUser.first_name;
            if (currentUser.photo_url) {
                document.getElementById('user-pic').src = currentUser.photo_url;
            }
            await loadGlobalSettings();
            await loadUserData();
            setupEventListeners();
        }

        async function loadGlobalSettings() {
            const doc = await db.collection('settings').doc('global').get();
            if (doc.exists) {
                globalSettings = doc.data();
                const inrRate = globalSettings.inrRate || 1000;
                document.getElementById('conversion-rate').innerText = `Rate: ${inrRate} üí∞ = ‚Çπ1`;
                document.getElementById('farming-rate-display').innerText = `${globalSettings.farmRate || '...'} üí∞/min`;
            }
        }

        async function loadUserData() {
            const userId = currentUser.id.toString();
            const userRef = db.collection('users').doc(userId);
            const doc = await userRef.get();

            if (doc.exists) {
                userData = doc.data();
                console.log("Fetched fresh user data from Firebase.");
            } else {
                console.log("Creating new user in Firebase.");
                userData = {
                    id: userId,
                    username: currentUser.username || 'N/A',
                    firstName: currentUser.first_name,
                    coins: 0,
                    xp: 0,
                    level: 1,
                    farmingStartTime: null,
                    farmingDuration: 24 * 60 * 60 * 1000,
                    referrals: [],
                    completedTasks: [],
                    exchangedTotal: 0,
                    dailyClaimStreak: 0,
                    lastClaimDate: null,
                    activeBooster: null,
                    boosterEndTime: null
                };
                await userRef.set(userData);
                // Check for referral on first-time user creation
                if (tg.initDataUnsafe.start_param) {
                    await handleReferral(tg.initDataUnsafe.start_param, userId);
                }
            }
            localStorage.setItem(`userData_${userId}`, JSON.stringify(userData));
            updateUI();
        }

       async function handleReferral(referrerId, newUserId) {
            if (referrerId === newUserId) {
                console.log("User tried to refer themselves.");
                return;
            }

            const referrerRef = db.collection('users').doc(referrerId);
            const transaction = db.runTransaction(async (t) => {
                const referrerDoc = await t.get(referrerRef);
                if (!referrerDoc.exists) {
                    throw "Referrer not found!";
                }

                const referrerData = referrerDoc.data();
                const existingReferrals = referrerData.referrals || [];
                if (existingReferrals.includes(newUserId)) {
                    console.log("User was already referred by this referrer.");
                    return; // No need to throw an error, just stop.
                }

                const referralReward = 500;
                const newCoins = (referrerData.coins || 0) + referralReward;
                const newReferrals = [...existingReferrals, newUserId];

                t.update(referrerRef, {
                    coins: newCoins,
                    referrals: newReferrals
                });
            });

            try {
                await transaction;
                console.log(`Awarded 500 coins to referrer ${referrerId}`);
            } catch (e) {
                console.error("Referral transaction failed: ", e);
            }
        }
        
        function updateUI() {
            if (!userData) return;
            document.getElementById('coin-balance-container').innerText = `üí∞ ${Math.floor(userData.coins)}`;
            checkFarmingStatus();
            updateBoosterDisplay();
            updateDailyClaimCalendar();
        }

        async function syncUserData(updatedData) {
            Object.assign(userData, updatedData);
            localStorage.setItem(`userData_${currentUser.id}`, JSON.stringify(userData));
            const userRef = db.collection('users').doc(currentUser.id.toString());
            try {
                await userRef.update(updatedData);
                console.log("Synced data:", updatedData);
                updateUI(); // Refresh UI after every sync
            } catch (error) {
                console.error("Error syncing data:", error);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => switchTab(e.currentTarget.dataset.tab));
            });
            document.getElementById('farm-button').addEventListener('click', handleFarmButtonClick);
            
            document.getElementById('task-type-input')?.addEventListener('change', (e) => {
                const keyContainer = document.getElementById('task-key-container');
                if (keyContainer) {
                    keyContainer.classList.toggle('hidden', e.target.value !== 'youtube_video');
                }
            });

            // Removed withdrawal method listener as we now only support UPI
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            if (tabId === 'shop-tab') loadBoosters();
            if (tabId === 'tasks-tab') loadTasks();
            if (tabId === 'referral-tab') loadReferralData();
            if (tabId === 'withdrawal-tab') loadWithdrawalHistory();
            if (tabId === 'profile-tab') updateProfileTab();
        }

        // --- BOOSTER FUNCTIONALITY --- //
        async function loadBoosters() {
            const boosterListEl = document.getElementById('booster-list');
            boosterListEl.innerHTML = '<p>Loading boosters...</p>';

            try {
                const boostersSnapshot = await db.collection('boosters').get();
                boosterListEl.innerHTML = '';

                if (boostersSnapshot.empty) {
                    boosterListEl.innerHTML = '<p>No boosters available.</p>';
                    return;
                }

                boostersSnapshot.forEach(doc => {
                    const booster = { id: doc.id, ...doc.data() };
                    const boosterCard = document.createElement('div');
                    boosterCard.className = 'booster-card';
                    boosterCard.innerHTML = `
                        <div class="booster-header">
                            <div class="booster-multiplier">${booster.multiplier}X Boost</div>
                            <div class="booster-duration">${Math.floor(booster.durationMinutes / 60)}h ${booster.durationMinutes % 60}m</div>
                        </div>
                        <div class="booster-buttons">
                            <button class="booster-btn stars" onclick="handleStarPurchase('${booster.id}')">
                                Buy with ${booster.starPrice} Stars ‚≠êÔ∏è
                            </button>
                            <button class="booster-btn upi" onclick="handleUPIPurchase('${booster.id}')">
                                Buy with ‚Çπ${booster.upiPriceINR} UPI
                            </button>
                        </div>
                    `;
                    boosterListEl.appendChild(boosterCard);
                });
            } catch (error) {
                console.error("Error loading boosters:", error);
                boosterListEl.innerHTML = '<p>Error loading boosters.</p>';
            }
        }

        window.handleStarPurchase = function(boosterId) {
            // Telegram Stars payment integration
            tg.showAlert("Stars payment integration requires backend implementation for Telegram's openInvoice API.");
        };

        window.handleUPIPurchase = async function(boosterId) {
            try {
                const boosterDoc = await db.collection('boosters').doc(boosterId).get();
                if (!boosterDoc.exists) {
                    tg.showAlert("Booster not found!");
                    return;
                }

                const booster = boosterDoc.data();
                const adminUPI = globalSettings.adminUpiID || 'admin@upi';
                
                document.getElementById('admin-upi-display').innerText = adminUPI;
                document.getElementById('upi-amount-display').innerText = booster.upiPriceINR;
                document.getElementById('upi-popup').setAttribute('data-booster-id', boosterId);
                document.getElementById('upi-popup').classList.add('show');
            } catch (error) {
                console.error("Error initiating UPI purchase:", error);
                tg.showAlert("Error loading payment details.");
            }
        };

        window.closeUPIPopup = function() {
            document.getElementById('upi-popup').classList.remove('show');
            document.getElementById('upi-transaction-id').value = '';
        };

        window.submitUPIPayment = async function() {
            const utr = document.getElementById('upi-transaction-id').value.trim();
            const boosterId = document.getElementById('upi-popup').getAttribute('data-booster-id');
            
            if (!utr) {
                tg.showAlert("Please enter the transaction ID (UTR).");
                return;
            }

            try {
                const boosterDoc = await db.collection('boosters').doc(boosterId).get();
                const booster = boosterDoc.data();

                const pendingOrder = {
                    userId: currentUser.id.toString(),
                    userName: currentUser.first_name || 'Unknown',
                    boosterId: boosterId,
                    boosterName: `${booster.multiplier}X Boost (${Math.floor(booster.durationMinutes / 60)}h)`,
                    amount: booster.upiPriceINR,
                    utr: utr,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('upi_pending_orders').add(pendingOrder);
                tg.showAlert("Payment submitted for verification! You'll receive your booster once approved.");
                closeUPIPopup();
            } catch (error) {
                console.error("Error submitting UPI payment:", error);
                tg.showAlert("Error submitting payment. Please try again.");
            }
        };

        async function activateBooster(boosterId) {
            try {
                const boosterDoc = await db.collection('boosters').doc(boosterId).get();
                if (!boosterDoc.exists) return;

                const booster = boosterDoc.data();
                const endTime = Date.now() + (booster.durationMinutes * 60 * 1000);

                await syncUserData({
                    activeBooster: {
                        multiplier: booster.multiplier,
                        endTime: endTime
                    },
                    boosterEndTime: endTime
                });

                tg.showAlert(`${booster.multiplier}X Booster activated for ${Math.floor(booster.durationMinutes / 60)} hours!`);
            } catch (error) {
                console.error("Error activating booster:", error);
            }
        }

        function updateBoosterDisplay() {
            const boosterDisplay = document.getElementById('active-booster-display');
            const multiplierText = document.getElementById('booster-multiplier-text');
            const boosterTimer = document.getElementById('booster-timer');

            if (userData.activeBooster && userData.boosterEndTime && Date.now() < userData.boosterEndTime) {
                boosterDisplay.classList.remove('hidden');
                boosterDisplay.classList.add('active');
                multiplierText.innerText = `${userData.activeBooster.multiplier}X`;
                
                const timeLeft = userData.boosterEndTime - Date.now();
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                boosterTimer.innerText = `${hours}h ${minutes}m left`;
            } else {
                boosterDisplay.classList.add('hidden');
                if (userData.activeBooster) {
                    // Booster expired, clear it
                    syncUserData({ activeBooster: null, boosterEndTime: null });
                }
            }
        }

        // --- DAILY CLAIM CALENDAR --- //
        function updateDailyClaimCalendar() {
            const calendarEl = document.getElementById('claim-calendar');
            const claimBtn = document.getElementById('daily-claim-btn');
            
            calendarEl.innerHTML = '';
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get last claim date
            const lastClaim = userData.lastClaimDate ? new Date(userData.lastClaimDate) : null;
            const canClaim = !lastClaim || 
                (lastClaim.getDate() !== currentDay || 
                 lastClaim.getMonth() !== currentMonth || 
                 lastClaim.getFullYear() !== currentYear);

            // Generate calendar for current month (simplified - just show 7 days)
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentYear, currentMonth, currentDay - 6 + i);
                const dayEl = document.createElement('div');
                dayEl.className = 'claim-day';
                dayEl.innerText = dayDate.getDate();
                
                if (dayDate.getDate() === currentDay && dayDate.getMonth() === currentMonth) {
                    dayEl.classList.add('today');
                    if (canClaim) {
                        dayEl.classList.add('available');
                    }
                }
                
                // Check if this day was claimed (simplified check)
                if (lastClaim && dayDate <= lastClaim && dayDate.getDate() !== currentDay) {
                    dayEl.classList.add('claimed');
                }
                
                calendarEl.appendChild(dayEl);
            }

            if (canClaim) {
                claimBtn.classList.remove('hidden');
            } else {
                claimBtn.classList.add('hidden');
            }
        }

        window.handleDailyClaim = async function() {
            const today = new Date();
            const lastClaim = userData.lastClaimDate ? new Date(userData.lastClaimDate) : null;
            
            // Check if already claimed today
            if (lastClaim && 
                lastClaim.getDate() === today.getDate() && 
                lastClaim.getMonth() === today.getMonth() && 
                lastClaim.getFullYear() === today.getFullYear()) {
                tg.showAlert("You've already claimed your daily reward today!");
                return;
            }

            const dailyReward = globalSettings.dailyClaimReward || 100;
            let streak = userData.dailyClaimStreak || 0;
            
            // Check if streak continues (claimed yesterday)
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (lastClaim && 
                lastClaim.getDate() === yesterday.getDate() && 
                lastClaim.getMonth() === yesterday.getMonth() && 
                lastClaim.getFullYear() === yesterday.getFullYear()) {
                streak += 1;
            } else if (!lastClaim || 
                       Math.abs(today - lastClaim) > 2 * 24 * 60 * 60 * 1000) {
                // Reset streak if more than 1 day gap
                streak = 1;
            }

            const bonusMultiplier = Math.min(1 + (streak - 1) * 0.1, 2.0); // Max 2x bonus
            const totalReward = Math.floor(dailyReward * bonusMultiplier);

            await syncUserData({
                coins: (userData.coins || 0) + totalReward,
                dailyClaimStreak: streak,
                lastClaimDate: today.toISOString()
            });

            tg.showAlert(`Daily reward claimed! +${totalReward} coins (${streak} day streak)`);
            updateUI();
        };

        // --- TASK LOGIC (NEW & DYNAMIC) --- //
        async function loadTasks() {
            const taskListEl = document.getElementById('task-list-dynamic');
            taskListEl.innerHTML = '<h4>Loading tasks...</h4>';

            const tasksSnapshot = await db.collection('tasks').get();
            taskListEl.innerHTML = '';

            // Add dynamic tasks from Firebase
            tasksSnapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const isCompleted = userData.completedTasks?.includes(task.id);
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <div class="task-info">
                        <h4>${task.name}</h4>
                        <p>Reward: ${task.reward} üí∞</p>
                    </div>
                    <button id="task-btn-${task.id}" ${isCompleted ? 'disabled' : ''}>
                        ${isCompleted ? 'Completed' : 'Go'}
                    </button>
                `;
                taskListEl.appendChild(taskItem);
                if (!isCompleted) {
                    document.getElementById(`task-btn-${task.id}`).onclick = () => handleTaskClick(task);
                }
            });

            // Add the static "Watch Ad" task
            const adTaskItem = document.createElement('div');
            adTaskItem.className = 'task-item';
            adTaskItem.innerHTML = `
                <div class="task-info">
                    <h4>üì∫ Watch Ad</h4>
                    <p>Reward: ${globalSettings.adReward || 50} üí∞</p>
                </div>
                <button onclick="watchAd()">Watch</button>
            `;
            taskListEl.appendChild(adTaskItem);
        }

                async function handleTaskClick(task) {
            const button = document.getElementById(`task-btn-${task.id}`);
            button.disabled = true;
            button.innerText = 'Checking...';

            switch (task.type) {
                case 'youtube_video':
                    tg.showAlert("You will be redirected to YouTube. Watch the video to find the secret key, then return to the app.");
                    tg.openLink(task.link);
                    
                    setTimeout(() => {
                        const key = prompt("Please enter the secret key from the video you just watched.");
                        (async () => {
                            if (key && key.trim().toLowerCase() === task.key.toLowerCase()) {
                                await grantTaskReward(task.id, task.reward);
                            } else {
                                tg.showAlert("Incorrect key, or you cancelled. Please try the task again.");
                                button.disabled = false;
                                button.innerText = 'Go';
                            }
                        })();
                    }, 2000);
                    break;

                case 'join_channel':
                case 'join_group':
                    tg.openLink(task.link);
                    const verified = confirm("Please join the channel/group, then press OK to verify and claim your reward.");
                    if (verified) {
                         await grantTaskReward(task.id, task.reward);
                    } else {
                         button.disabled = false;
                         button.innerText = 'Go';
                    }
                    break;

                case 'visit_link':
                default:
                    tg.openLink(task.link);
                     await grantTaskReward(task.id, task.reward);
                    break;
            }
        }

        async function grantTaskReward(taskId, reward) {
            if (userData.completedTasks?.includes(taskId)) {
                tg.showAlert("You have already completed this task.");
                return;
            }
            const newCoins = (userData.coins || 0) + reward;
            const newCompletedTasks = [...(userData.completedTasks || []), taskId];
            await syncUserData({ coins: newCoins, completedTasks: newCompletedTasks });

            tg.showAlert(`Task completed! You earned ${reward} coins. üéâ`);
            const button = document.getElementById(`task-btn-${taskId}`);
            if (button) {
                button.innerText = 'Completed';
                button.disabled = true;
            }
        }

        window.watchAd = function() {
            const reward = globalSettings.adReward || 50;
            tg.showConfirm(`Watch an ad to earn ${reward} coins?`, async (confirmed) => {
                if (confirmed) {
                    // Simulate ad watching for simplicity
                    tg.showPopup({
                        title: 'Watch Ad',
                        message: 'Please watch the ad video to completion...',
                        buttons: [{ type: 'ok', text: 'I Watched It' }]
                    });
                    const newCoins = (userData.coins || 0) + reward;
                    await syncUserData({ coins: newCoins });
                    tg.showAlert(`Ad watched! You earned ${reward} coins. üéâ`);
                }
            });
        };

        // --- FARMING LOGIC --- //
        function handleFarmButtonClick() {
            const button = document.getElementById('farm-button');
            if (button.innerText.includes('Start')) {
                startFarming();
            } else if (button.innerText.includes('Claim')) {
                claimReward();
            }
        }

        async function startFarming() {
            await syncUserData({ farmingStartTime: Date.now() });
            checkFarmingStatus();
        }

        async function claimReward() {
            const farmRate = globalSettings.farmRate || 100;
            const elapsedMinutes = userData.farmingDuration / (60 * 1000);
            
            // Apply booster multiplier if active
            let multiplier = 1;
            if (userData.activeBooster && userData.boosterEndTime && Date.now() < userData.boosterEndTime) {
                multiplier = userData.activeBooster.multiplier;
            }
            
            const baseCoins = farmRate * elapsedMinutes;
            const coinsEarned = baseCoins * multiplier;
            const newCoins = userData.coins + coinsEarned;
            const newXp = (userData.xp || 0) + 100;
            
            await syncUserData({ coins: newCoins, farmingStartTime: null, xp: newXp });
            
            const message = multiplier > 1 ? 
                `You claimed ${coinsEarned.toFixed(0)} coins! (${multiplier}X boost applied)` :
                `You claimed ${coinsEarned.toFixed(0)} coins!`;
            tg.showAlert(message);
            
            checkLevelUp(userData.xp, newXp);
            updateUI();
        }

        function checkFarmingStatus() {
            const button = document.getElementById('farm-button');
            const timerEl = document.getElementById('farm-timer');
            const progressEl = document.getElementById('farm-progress');
            if (farmInterval) clearInterval(farmInterval);

            if (userData.farmingStartTime) {
                const endTime = userData.farmingStartTime + userData.farmingDuration;
                farmInterval = setInterval(() => {
                    const now = Date.now();
                    const timeLeft = endTime - now;
                    if (timeLeft <= 0) {
                        clearInterval(farmInterval);
                        button.innerText = 'Claim Reward';
                        button.disabled = false;
                        timerEl.innerText = 'Farming complete!';
                        progressEl.style.width = '100%';
                        return;
                    }
                    button.innerText = 'Farming...';
                    button.disabled = true;
                    const hours = Math.floor((timeLeft / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((timeLeft / 1000 / 60) % 60);
                    const seconds = Math.floor((timeLeft / 1000) % 60);
                    timerEl.innerText = `Time left: ${hours}h ${minutes}m ${seconds}s`;
                    const progress = 100 - (timeLeft / userData.farmingDuration) * 100;
                    progressEl.style.width = `${progress}%`;
                }, 1000);
            } else {
                button.innerText = 'Start Farming';
                button.disabled = false;
                timerEl.innerText = 'Ready to farm!';
                progressEl.style.width = '0%';
            }
        }
        
        // --- WITHDRAWAL HISTORY FUNCTIONS --- //
        async function loadWithdrawalHistory() { 
            try {
                const querySnapshot = await db.collection('withdrawals')
                    .where('userId', '==', currentUser.id.toString())
                    .get();
                
                const listEl = document.getElementById('withdrawal-history-list');
                listEl.innerHTML = '';
                
                if (querySnapshot.empty) { 
                    listEl.innerHTML = '<p>No withdrawal history found.</p>'; 
                    return; 
                } 
                
                querySnapshot.forEach(doc => { 
                    const data = doc.data();
                    let dateString = data.timestamp?.toDate ? data.timestamp.toDate().toLocaleDateString() : 'Unknown date';
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="history-info">
                            <strong>‚Çπ${data.amount || 0} UPI Withdrawal</strong><br>
                            <small>To: ${data.upiId || data.address || 'N/A'}</small><br>
                            <small>Name: ${data.recipientName || data.userName || 'N/A'}</small><br>
                            <small>Date: ${dateString} | Status: <span style="color: ${data.status === 'approved' ? 'green' : data.status === 'rejected' ? 'red' : 'orange'}">${data.status || 'pending'}</span></small>
                            ${data.adminNote ? `<br><small>Note: ${data.adminNote}</small>` : ''}
                        </div>
                    `;
                    listEl.appendChild(item);
                });
            } catch (error) {
                console.error("Error loading withdrawal history:", error);
                document.getElementById('withdrawal-history-list').innerHTML = '<p>Error loading history.</p>';
            }
        }

        window.requestWithdrawal = async function() { 
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const upiId = document.getElementById('withdrawal-upi').value.trim();
            const name = document.getElementById('withdrawal-name').value.trim();
            
            if (isNaN(amount) || amount <= 0 || !upiId || !name) {
                tg.showAlert("Please fill all withdrawal fields correctly.");
                return;
            }
            
            const userExchanged = (userData.exchangedTotal || 0);
            if (amount > userExchanged) {
                tg.showAlert(`Insufficient exchanged balance. You have ‚Çπ${userExchanged.toFixed(2)} available.`);
                return;
            }
            
            try {
                const withdrawalData = {
                    userId: currentUser.id.toString(),
                    userName: currentUser.first_name || 'Unknown',
                    amount: amount,
                    upiId: upiId,
                    recipientName: name,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('withdrawals').add(withdrawalData);
                
                const newExchangedTotal = userExchanged - amount;
                await syncUserData({ exchangedTotal: newExchangedTotal });
                
                tg.showAlert("UPI withdrawal request submitted successfully!");
                document.getElementById('withdrawal-amount').value = '';
                document.getElementById('withdrawal-upi').value = '';
                document.getElementById('withdrawal-name').value = '';
                loadWithdrawalHistory();
                
            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                tg.showAlert("Error submitting withdrawal request.");
            }
        };

        // --- ANIMATIONS & OTHER TABS --- //
        function checkLevelUp(oldXp, newXp) { const levelThreshold = (level) => Math.floor(100 * Math.pow(level, 1.5)); const currentLevelThreshold = levelThreshold(userData.level); if (newXp >= currentLevelThreshold) { const newLevel = userData.level + 1; syncUserData({ level: newLevel }); showLevelUpPopup(newLevel); } }
        function showLevelUpPopup(level) { const popup = document.getElementById('level-up-popup'); document.getElementById('new-level').innerText = `Level ${level}`; popup.classList.add('show'); createConfetti(); setTimeout(() => popup.classList.remove('show'), 4000); }
        function createConfetti() { const container = document.getElementById('confetti-container'); container.innerHTML = ''; for (let i = 0; i < 100; i++) { const confetti = document.createElement('div'); confetti.style.position = 'absolute'; confetti.style.width = `${Math.random() * 10 + 5}px`; confetti.style.height = confetti.style.width; confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`; confetti.style.left = `${Math.random() * 100}%`; confetti.style.top = `${-20}%`; confetti.style.animation = `confetti-fall ${Math.random() * 2 + 3}s linear ${Math.random() * 2}s forwards`; container.appendChild(confetti); } }
        const styleSheet = document.createElement("style"); styleSheet.type = "text/css"; styleSheet.innerText = `@keyframes confetti-fall { to { transform: translateY(150vh) rotate(${Math.random() * 720}deg); opacity: 0; } }`; document.head.appendChild(styleSheet);

        function updateProfileTab() { document.getElementById('profile-userid').innerText = userData.id; document.getElementById('profile-coins').innerText = Math.floor(userData.coins); document.getElementById('profile-exchanged').innerText = `‚Çπ${(userData.exchangedTotal || 0).toFixed(2)}`; document.getElementById('profile-referrals').innerText = userData.referrals?.length || 0; document.getElementById('profile-level').innerText = userData.level; }

        window.convertCoins = async function() { 
            const amount = parseInt(document.getElementById('convert-amount').value); 
            if (isNaN(amount) || amount <= 0) { tg.showAlert("Enter a valid coin amount."); return; } 
            if (amount > (userData.coins || 0)) { tg.showAlert("You do not have enough coins."); return; } 
            
            const rate = globalSettings.inrRate || 1000; // Coins per 1 INR
            const converted = amount / rate; 
            
            await syncUserData({ 
                coins: (userData.coins || 0) - amount, 
                exchangedTotal: (userData.exchangedTotal || 0) + converted 
            }); 
            tg.showAlert(`Converted ${amount} coins into ‚Çπ${converted.toFixed(2)}.`); 
            updateUI(); 
        };

        function loadReferralData() { 
            const linkInput = document.getElementById('referral-link'); 
            linkInput.value = `https://t.me/@farmingbooster_bot?start=${currentUser.id}`; // Update with your actual bot username
            const displayEl = document.getElementById('referral-history-list'); 
            const referralCount = userData.referrals?.length || 0; 
            if (referralCount === 0) { 
                displayEl.innerHTML = `<p>No referrals yet. Share your link to earn 500 coins per referral!</p>`; 
            } else { 
                displayEl.innerHTML = `<p>You have referred <strong>${referralCount} users</strong> and earned <strong>${referralCount * 500} coins</strong>!</p><div style="margin-top: 10px;"><strong>Referred User IDs:</strong><br>${userData.referrals.map(id => `‚Ä¢ ${id}`).join('<br>')}</div>`; 
            } 
        }

        window.copyReferralLink = async function() { const linkInput = document.getElementById('referral-link'); try { await navigator.clipboard.writeText(linkInput.value); tg.showAlert('Referral link copied!'); } catch (err) { linkInput.select(); document.execCommand('copy'); tg.showAlert('Referral link copied!'); } };
    
        // --- ADMIN PANEL LOGIC (EXPANDED) --- //
        window.handleAdminLogin = function() {
            const email = document.getElementById('admin-email').value;
            const pass = document.getElementById('admin-password').value;
            if (email === 'admin@gmail.com' && pass === 'admin123') {
                document.getElementById('admin-login-screen').classList.add('hidden');
                document.getElementById('admin-dashboard').classList.remove('hidden');
                loadAdminData();
            } else {
                document.getElementById('admin-login-error').innerText = "Invalid credentials.";
            }
        }
        async function loadAdminData() {
            // Load Settings
            const settings = (await db.collection('settings').doc('global').get()).data() || {};
            document.getElementById('setting-farm-rate').value = settings.farmRate || 100;
            document.getElementById('setting-daily-reward').value = settings.dailyClaimReward || 100;
            document.getElementById('setting-inr-rate').value = settings.inrRate || 1000;
            document.getElementById('setting-admin-upi').value = settings.adminUpiID || '';
            
            // Load Withdrawals (UPI only)
            const wSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            const wTableBody = document.querySelector('#withdrawal-requests-table tbody');
            wTableBody.innerHTML = '';
            wSnapshot.forEach(doc => {
                const data = doc.data();
                const row = wTableBody.insertRow();
                row.innerHTML = `<td>${data.userId}</td><td>‚Çπ${data.amount}</td><td>${data.upiId || data.address}</td><td>${data.recipientName || data.userName}</td><td>${data.status}</td><td><button onclick="updateWithdrawalStatus('${doc.id}', 'approved')">Approve</button><button onclick="updateWithdrawalStatus('${doc.id}', 'rejected')" style="background:var(--danger-color)">Reject</button></td>`;
            });

            loadAdminTasks();
            loadAdminBoosters();
            loadUPIPendingOrders();
            loadAdminDashboardStats();
        }
        async function loadAdminDashboardStats() {
            const usersSnapshot = await db.collection('users').get();
            const withdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
            let totalCoins = 0;
            usersSnapshot.forEach(doc => { totalCoins += doc.data().coins || 0; });
            document.getElementById('stats-total-users').innerText = usersSnapshot.size;
            document.getElementById('stats-total-coins').innerText = Math.floor(totalCoins);
            document.getElementById('stats-pending-withdrawals').innerText = withdrawalsSnapshot.size;
        }
        async function loadAdminTasks() {
            const tasksSnapshot = await db.collection('tasks').get();
            const tableBody = document.querySelector('#tasks-table tbody');
            tableBody.innerHTML = '';
            tasksSnapshot.forEach(doc => {
                const task = { id: doc.id, ...doc.data() };
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${task.name}</td>
                    <td>${task.reward}</td>
                    <td>${task.type}</td>
                    <td>
                        <button onclick='editAdminTask("${task.id}", ${JSON.stringify(task)})'>Edit</button>
                        <button onclick='deleteAdminTask("${task.id}")' style="background:var(--danger-color)">Delete</button>
                    </td>
                `;
            });
        }
        window.editAdminTask = function(id, taskData) {
            document.getElementById('task-id-input').value = id;
            document.getElementById('task-name-input').value = taskData.name;
            document.getElementById('task-reward-input').value = taskData.reward;
            document.getElementById('task-type-input').value = taskData.type;
            document.getElementById('task-link-input').value = taskData.link;
            document.getElementById('task-key-input').value = taskData.key || '';
            document.getElementById('task-type-input').dispatchEvent(new Event('change'));
            window.scrollTo(0, 0);
        };
        window.deleteAdminTask = async function(id) {
            if (confirm("Are you sure you want to delete this task?")) {
                await db.collection('tasks').doc(id).delete();
                alert("Task deleted.");
                loadAdminTasks();
            }
        };
        window.saveAdminTask = async function() {
            const taskId = document.getElementById('task-id-input').value;
            const taskData = {
                name: document.getElementById('task-name-input').value,
                reward: parseInt(document.getElementById('task-reward-input').value),
                type: document.getElementById('task-type-input').value,
                link: document.getElementById('task-link-input').value,
                key: document.getElementById('task-key-input').value.trim()
            };
            
            if (!taskData.name || !taskData.reward || !taskData.link) {
                alert("Please fill Name, Reward, and Link fields.");
                return;
            }
            if (taskData.type === 'youtube_video' && !taskData.key) {
                alert("For YouTube tasks, the secret key is required.");
                return;
            }
            if (taskData.type !== 'youtube_video') {
                delete taskData.key;
            }
            
            try {
                if (taskId) {
                    await db.collection('tasks').doc(taskId).update(taskData);
                    alert("Task updated!");
                } else {
                    await db.collection('tasks').add(taskData);
                    alert("Task added!");
                }
            } catch (error) {
                console.error("Error saving task: ", error);
                alert("Could not save the task.");
            }
            
            document.getElementById('task-id-input').value = '';
            document.getElementById('task-name-input').value = '';
            document.getElementById('task-reward-input').value = '';
            document.getElementById('task-link-input').value = '';
            document.getElementById('task-key-input').value = '';
            document.getElementById('task-key-container').classList.add('hidden');
            loadAdminTasks();
        };

        async function loadAdminBoosters() {
            const boostersSnapshot = await db.collection('boosters').get();
            const tableBody = document.querySelector('#boosters-table tbody');
            tableBody.innerHTML = '';
            boostersSnapshot.forEach(doc => {
                const booster = { id: doc.id, ...doc.data() };
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${booster.multiplier}X</td>
                    <td>${booster.durationMinutes}min</td>
                    <td>${booster.starPrice}</td>
                    <td>‚Çπ${booster.upiPriceINR}</td>
                    <td>
                        <button onclick='editBooster("${booster.id}", ${JSON.stringify(booster)})'>Edit</button>
                        <button onclick='deleteBooster("${booster.id}")' style="background:var(--danger-color)">Delete</button>
                    </td>
                `;
            });
        }

        async function loadUPIPendingOrders() {
            const ordersSnapshot = await db.collection('upi_pending_orders').where('status', '==', 'pending').get();
            const tableBody = document.querySelector('#upi-pending-table tbody');
            tableBody.innerHTML = '';
            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${order.userName} (${order.userId})</td>
                    <td>${order.boosterName}</td>
                    <td>‚Çπ${order.amount}</td>
                    <td>${order.utr}</td>
                    <td>
                        <button onclick="approveUPIOrder('${doc.id}', '${order.boosterId}', '${order.userId}')">Approve</button>
                        <button onclick="rejectUPIOrder('${doc.id}')" style="background:var(--danger-color)">Reject</button>
                    </td>
                `;
            });
        }

        window.editBooster = function(id, boosterData) {
            document.getElementById('booster-id-input').value = id;
            document.getElementById('booster-multiplier-input').value = boosterData.multiplier;
            document.getElementById('booster-duration-input').value = boosterData.durationMinutes;
            document.getElementById('booster-star-price-input').value = boosterData.starPrice;
            document.getElementById('booster-upi-price-input').value = boosterData.upiPriceINR;
            window.scrollTo(0, 0);
        };

        window.deleteBooster = async function(id) {
            if (confirm("Are you sure you want to delete this booster?")) {
                await db.collection('boosters').doc(id).delete();
                alert("Booster deleted.");
                loadAdminBoosters();
            }
        };

        window.saveBooster = async function() {
            const boosterId = document.getElementById('booster-id-input').value;
            const boosterData = {
                multiplier: parseFloat(document.getElementById('booster-multiplier-input').value),
                durationMinutes: parseInt(document.getElementById('booster-duration-input').value),
                starPrice: parseInt(document.getElementById('booster-star-price-input').value),
                upiPriceINR: parseInt(document.getElementById('booster-upi-price-input').value)
            };
            
            if (!boosterData.multiplier || !boosterData.durationMinutes || !boosterData.starPrice || !boosterData.upiPriceINR) {
                alert("Please fill all booster fields.");
                return;
            }
            
            try {
                if (boosterId) {
                    await db.collection('boosters').doc(boosterId).update(boosterData);
                    alert("Booster updated!");
                } else {
                    await db.collection('boosters').add(boosterData);
                    alert("Booster added!");
                }
            } catch (error) {
                console.error("Error saving booster: ", error);
                alert("Could not save the booster.");
            }
            
            document.getElementById('booster-id-input').value = '';
            document.getElementById('booster-multiplier-input').value = '';
            document.getElementById('booster-duration-input').value = '';
            document.getElementById('booster-star-price-input').value = '';
            document.getElementById('booster-upi-price-input').value = '';
            loadAdminBoosters();
        };

        window.approveUPIOrder = async function(orderId, boosterId, userId) {
            try {
                // Update order status
                await db.collection('upi_pending_orders').doc(orderId).update({ status: 'approved' });
                
                // Activate booster for user
                const boosterDoc = await db.collection('boosters').doc(boosterId).get();
                if (boosterDoc.exists) {
                    const booster = boosterDoc.data();
                    const endTime = Date.now() + (booster.durationMinutes * 60 * 1000);
                    
                    await db.collection('users').doc(userId).update({
                        activeBooster: {
                            multiplier: booster.multiplier,
                            endTime: endTime
                        },
                        boosterEndTime: endTime
                    });
                }
                
                alert("UPI payment approved and booster activated!");
                loadUPIPendingOrders();
            } catch (error) {
                console.error("Error approving UPI order:", error);
                alert("Error approving payment.");
            }
        };

        window.rejectUPIOrder = async function(orderId) {
            try {
                await db.collection('upi_pending_orders').doc(orderId).update({ status: 'rejected' });
                alert("UPI payment rejected.");
                loadUPIPendingOrders();
            } catch (error) {
                console.error("Error rejecting UPI order:", error);
                alert("Error rejecting payment.");
            }
        };

        window.saveAdminSettings = async function() {
            const settings = {
                farmRate: parseInt(document.getElementById('setting-farm-rate').value),
                dailyClaimReward: parseInt(document.getElementById('setting-daily-reward').value),
                inrRate: parseInt(document.getElementById('setting-inr-rate').value),
                adminUpiID: document.getElementById('setting-admin-upi').value.trim()
            };
            await db.collection('settings').doc('global').set(settings, { merge: true });
            alert("Settings saved!");
        };
        window.updateWithdrawalStatus = async function(docId, status) {
            const reason = prompt(`Enter reason for ${status} (optional):`);
            await db.collection('withdrawals').doc(docId).update({ status: status, adminNote: reason || '' });
            alert(`Withdrawal ${status}.`);
            loadAdminData();
        };
        window.sendBroadcast = function() {
            alert("Broadcast feature requires a backend bot to send messages to all users.");
        }

        // --- START THE APP --- //
        initializeApp();
    });
</script>
</body>
</html>